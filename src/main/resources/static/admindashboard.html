<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Smart College</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    /* ========================================
   1. CORE VARIABLES & RESET
   ======================================== 
*/
:root { 
    --admin-theme: #0f172a; 
    --accent: #4f46e5; 
    --sidebar-width: 260px;
    --glass: rgba(255, 255, 255, 0.98);
    --bg-body: #f8fafc;
    --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

body { 
    background-color: var(--bg-body); 
    font-family: 'Inter', sans-serif; 
    overflow-x: hidden; 
    color: #1e293b;
}

/* ========================================
   2. SIDEBAR (With Scroll & Animation)
   ======================================== 
*/
.sidebar { 
    width: var(--sidebar-width); 
    height: 100vh; 
    position: fixed; 
    top: 0;
    left: 0;
    background: var(--admin-theme); 
    color: white; 
    transition: var(--transition-smooth);
    z-index: 2100;
    display: flex;
    flex-direction: column;
    /* Allows the menu items to scroll if they exceed screen height */
    overflow-y: auto; 
    box-shadow: 4px 0 15px rgba(0,0,0,0.2);
}

/* Custom Scrollbar for Sidebar */
.sidebar::-webkit-scrollbar {
    width: 5px;
}
.sidebar::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

.main-content { 
    margin-left: var(--sidebar-width); 
    padding: 30px; 
    transition: var(--transition-smooth); 
}

/* Sidebar Responsive Logic */
@media (max-width: 992px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.active { transform: translateX(0); }
    .main-content { margin-left: 0; padding: 20px; padding-bottom: 100px !important; }
    
    .overlay { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(15, 23, 42, 0.5); 
        backdrop-filter: blur(4px); 
        z-index: 2050; 
        transition: opacity 0.3s ease;
    }
    .overlay.active { display: block; opacity: 1; }
}

/* ========================================
   3. NAVIGATION LINKS
   ======================================== 
*/
.nav-link { 
    color: #94a3b8; 
    padding: 12px 20px; 
    border-radius: 12px; 
    margin: 4px 15px; 
    transition: 0.3s; 
    cursor: pointer; 
    display: flex;
    align-items: center;
    text-decoration: none;
}

.nav-link:hover { color: #f8fafc; background: rgba(255,255,255,0.05); }
.nav-link.active { 
    color: white !important; 
    background: var(--accent) !important; 
    box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4); 
}

/* ========================================
   4. TABLES (Responsive & Sticky Column)
   ======================================== 
*/
.table-responsive-custom {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border-radius: 16px;
    background: white;
}

/* Desktop Tables */
.table { border-collapse: separate; border-spacing: 0 8px; width: 100%; }
.table thead th { border: none; font-weight: 600; color: #64748b; text-transform: uppercase; font-size: 0.75rem; padding: 12px; }
.table tbody tr { background: white; transition: 0.2s; }
.table td { border-bottom: 1px solid #f1f5f9; padding: 16px 12px; }

/* Sticky first column for mobile (Student Name stays visible) */
@media (max-width: 480px) {
    .table-responsive-custom table { min-width: 700px; } /* Force scroll */
    
    .table td:first-child, 
    .table th:first-child {
        position: sticky;
        left: 0;
        background: white !important;
        z-index: 10;
        border-right: 2px solid #f1f5f9;
    }
    .table th:first-child { background: #f8fafc !important; }
}

/* ========================================
   5. MOBILE BOTTOM NAV
   ======================================== 
*/
.mobile-bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: white;
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 1px solid #e2e8f0;
    z-index: 2000;
    padding-bottom: env(safe-area-inset-bottom);
    box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
}

.bottom-nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #94a3b8;
    font-size: 10px;
    font-weight: 600;
    background: none;
    border: none;
    padding: 10px;
    flex: 1;
}

.bottom-nav-item i { font-size: 20px; margin-bottom: 4px; }
.bottom-nav-item.active { color: var(--accent); }

/* ========================================
   6. UI COMPONENTS (Cards & Buttons)
   ======================================== 
*/
.card { 
    border: 1px solid rgba(226, 232, 240, 0.8); 
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
    border-radius: 16px; 
    background: var(--glass);
}

.stat-icon { 
    width: 54px; height: 54px; 
    border-radius: 14px; 
    display: flex; align-items: center; justify-content: center; 
    font-size: 26px; 
}

/* Section Fade Animation */
.section-fade { animation: fadeIn 0.4s ease-out; }
@keyframes fadeIn { 
    from { opacity: 0; transform: translateY(10px); } 
    to { opacity: 1; transform: translateY(0); } 
}

.hidden { display: none !important; }

/* Container that allows horizontal swiping */
.table-responsive-custom {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scroll for iOS */
    position: relative;
}

/* Force a minimum width on mobile so columns don't disappear */
@media (max-width: 768px) {
    .table-responsive-custom table {
        min-width: 800px; /* Adjust based on your column count */
    }

    /* Keep Student Name visible while sliding */
    .sticky-col {
        position: sticky;
        left: 0;
        background-color: #f8fafc !important; /* Matches bg-light */
        z-index: 11;
        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    }

    /* Apply sticky to body cells as well */
    #admin-fees-table td:first-child {
        position: sticky;
        left: 0;
        background-color: white !important;
        z-index: 10;
        box-shadow: 2px 0 5px rgba(0,0,0,0.05);
    }
}

/* Custom Scrollbar for the table */
.table-responsive-custom::-webkit-scrollbar {
    height: 6px;
}
.table-responsive-custom::-webkit-scrollbar-thumb {
    background: #e2e8f0;
    border-radius: 10px;
}

</style>
</head>
<body>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <button class="btn btn-primary d-lg-none position-fixed bottom-0 end-0 m-4 rounded-circle shadow-lg z-3" 
            style="width: 60px; height: 60px;" onclick="toggleSidebar()">
        <i class="bi bi-list fs-3"></i>
    </button>

    <div class="sidebar d-flex flex-column" id="sidebar">
        <div class="text-center py-5">
            <div class="bg-primary d-inline-block p-2 rounded-3 mb-2 shadow-lg">
                <i class="bi bi-mortarboard-fill text-white fs-4"></i>
            </div>
            <h4 class="fw-bold text-white mb-0">Smart College</h4>
            <small class="text-secondary text-uppercase tracking-widest" style="font-size: 0.65rem;">Administrator</small>
        </div>

   <div class="px-3 mb-4">
    <p class="text-secondary small fw-bold px-3 mb-2">MENU</p>
    <ul class="nav nav-pills flex-column">
    <li class="nav-item">
        <a id="nav-overview" class="nav-link active" onclick="showSection('overview')">
            <i class="bi bi-grid-1x2 me-3"></i> Dashboard
        </a>
    </li>
    <li class="nav-item">
        <a id="nav-fees" class="nav-link" onclick="showSection('fees')">
            <i class="bi bi-wallet2 me-3"></i> Fees Management
        </a>
    </li>
    <li class="nav-item">
        <a id="nav-attendance" class="nav-link" onclick="showSection('attendance')">
            <i class="bi bi-calendar-check me-3"></i> Attendance Logs
        </a>
    </li>
    <li class="nav-item">
        <a id="nav-assign" class="nav-link" onclick="showSection('assign')">
            <i class="bi bi-person-plus me-3"></i> Assign Mentors
        </a>
    </li>
    <li class="nav-item">
        <a id="nav-students" class="nav-link" onclick="showSection('students')">
            <i class="bi bi-people me-3"></i> Student Database
        </a>
    </li>
    <li class="nav-item">
        <a id="nav-faculty" class="nav-link" onclick="showSection('faculty')">
            <i class="bi bi-person-badge me-3"></i> Faculty Directory
        </a>
    </li>
    <li class="nav-item">
    <a id="nav-academic" class="nav-link" onclick="showSection('academic')">
        <i class="bi bi-journal-bookmark me-3"></i> Academic Records
    </a>
</li>
</ul>
</div>

        <div class="mt-auto p-4">
            <button class="btn btn-outline-danger w-100 rounded-3 border-0 bg-dark-subtle" onclick="logout()">
                <i class="bi bi-box-arrow-left me-2"></i> Sign Out
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <h2 class="fw-bold mb-1" id="pageTitle">Dashboard</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="#" class="text-decoration-none text-muted small">Admin</a></li>
                        <li class="breadcrumb-item active small text-primary" aria-current="page" id="breadcrumb-current">Overview</li>
                    </ol>
                </nav>
            </div>
            <div class="d-flex align-items-center bg-white p-2 rounded-4 shadow-sm">
                <div class="me-3 text-end d-none d-sm-block">
                    <p class="mb-0 fw-bold small" id="admin-name">Admin User</p>
                    <span class="text-muted" style="font-size: 0.7rem;">Chief Administrator</span>
                </div>
                <div class="bg-primary-subtle text-primary rounded-3 p-2">
                    <i class="bi bi-person-vcard fs-5"></i>
                </div>
            </div>
        </div>

        <div id="overview-section" class="section-fade">
            <div class="row g-4 mb-5">
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card p-4 border-0">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-primary-subtle text-primary me-3">
                                <i class="bi bi-person-workspace"></i>
                            </div>
                            <div>
                                <p class="text-muted small fw-semibold mb-1">Active Faculty</p>
                                <h2 id="total-faculty" class="fw-bold mb-0">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-xl-4">
                    <div class="card p-4 border-0">
                        <div class="d-flex align-items-center">
                            <div class="stat-icon bg-success-subtle text-success me-3">
                                <i class="bi bi-mortarboard"></i>
                            </div>
                            <div>
                                <p class="text-muted small fw-semibold mb-1">Enrolled Students</p>
                                <h2 id="total-students" class="fw-bold mb-0">0</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      <div id="assign-section" class="d-none section-fade pb-5">
    <div class="row g-3 g-lg-4">
        <div class="col-lg-5 col-xl-4">
            <div class="card p-3 p-md-4 border-0 shadow-sm h-100 rounded-4">
                <div class="text-center mb-3 mb-md-4">
                    <div class="stat-icon bg-indigo text-white mx-auto mb-3" style="background: var(--accent); width: 60px; height: 60px;">
                        <i class="bi bi-shield-check fs-4"></i>
                    </div>
                    <h5 class="fw-bold mb-1">Select Mentor</h5>
                    <p class="text-muted small px-2">Assign a designated faculty member for guidance.</p>
                </div>
                
                <div class="form-group">
                    <label class="small fw-bold mb-2 text-muted text-uppercase">Faculty Member</label>
                    <select id="faculty-dropdown" class="form-select border-0 bg-light p-3 rounded-3 shadow-none custom-select-mobile">
                        <option value="">Fetching faculty list...</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="col-lg-7 col-xl-8">
            <div class="card p-3 p-md-4 border-0 shadow-sm rounded-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 mb-md-4 gap-2">
                    <div>
                        <h5 class="fw-bold mb-0">Select Students</h5>
                        <p class="text-muted small mb-0">Link multiple students to the chosen faculty</p>
                    </div>
                    <span class="badge bg-primary-subtle text-primary rounded-pill px-3 py-2 w-fit-content">
                        Multi-select enabled
                    </span>
                </div>
                
                <div class="input-group mb-3 bg-light rounded-3 overflow-hidden border-0 shadow-sm">
                    <span class="input-group-text border-0 bg-transparent ps-3 text-muted"><i class="bi bi-search"></i></span>
                    <input type="text" id="studentFilter" class="form-control border-0 bg-transparent p-3 shadow-none" 
                           placeholder="Search name or email..." onkeyup="filterStudents()">
                </div>

                <div class="student-select-wrapper position-relative">
                    <select id="student-multiselect" class="form-select border-0 bg-light rounded-3 p-2" 
                            multiple style="height: 350px; font-size: 0.95rem;">
                        </select>
                    <div class="small text-muted mt-2 d-md-none italic text-center">
                        <i class="bi bi-info-circle me-1"></i> Hold & drag to select multiple
                    </div>
                </div>

                <div class="mt-4 d-none d-md-block">
                    <button class="btn btn-primary btn-lg w-100 rounded-3 shadow" onclick="processAssignment()">
                        <i class="bi bi-check2-all me-2"></i> Update Mentorship Links
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-action-bar d-md-none">
        <button class="btn btn-primary w-100 py-3 shadow-lg fw-bold" onclick="processAssignment()">
            <i class="bi bi-check2-all me-2"></i> UPDATE LINKS
        </button>
    </div>
</div>
<div id="manage-faculty-section" class="d-none section-fade">
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
                <div>
                    <h4 class="fw-bold mb-1">Faculty Directory</h4>
                    <p class="text-muted small mb-0">Total staff members currently active in the system</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-success rounded-3 px-4 d-flex align-items-center" onclick="downloadFacultyExcel()">
                        <i class="bi bi-file-earmark-excel me-2"></i> Export
                    </button>
                    <button class="btn btn-primary rounded-3 px-4 d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#facultyModal" onclick="resetFacultyForm()">
                        <i class="bi bi-plus-circle me-2"></i> Add Faculty
                    </button>
                </div>
            </div>

            <div class="table-responsive">
            <div class="input-group mb-4 bg-white shadow-sm rounded-4 overflow-hidden border-0">
    <span class="input-group-text bg-white border-0 ps-3">
        <i class="bi bi-search text-primary"></i>
    </span>
    <input type="text" id="globalSearch" class="form-control border-0 p-3 shadow-none" 
           placeholder="Search by name, email, or ID..." onkeyup="filterTableData()">
</div>
                <table class="table align-middle custom-faculty-table">
                    <thead>
                        <tr>
                            <th class="ps-4">Faculty ID</th>
                            <th>Staff Information</th>
                            <th>Specialization</th>
                            <th>Rank</th>
                            <th>Annual Salary</th>
                            <th class="text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-faculty-table">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

        <div id="manage-students-section" class="d-none section-fade">
            <div class="card p-4 border-0 shadow-sm">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
                    <div>
                        <h4 class="fw-bold mb-1">Student Database</h4>
                        <p class="text-muted small mb-0">Profiles, records, and mentorship status</p>
                    </div>
                    <button class="btn btn-primary rounded-3 px-4 py-2 d-flex align-items-center" data-bs-toggle="modal" data-bs-target="#registrationModal">
                        <i class="bi bi-plus-circle me-2"></i> Register New Student
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr>
                                <th class="ps-4">ID</th>
                                <th>Student Details</th>
                                <th>Course</th>
                                <th>Mentorship</th>
                                <th class="text-center">Manage</th>
                            </tr>
                        </thead>
                        <tbody id="admin-student-table">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
      <section id="manage-fees-section" class="d-none section-fade">
    <div class="px-3 mb-3">
        <div class="input-group bg-white shadow-sm rounded-3 overflow-hidden" style="max-width: 400px;">
            <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-search"></i></span>
            <input type="text" id="feesSearch" class="form-control border-0 shadow-none" 
                   placeholder="Search by student name or ID..." onkeyup="filterFeesTable()">
        </div>
    </div>

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 p-3 gap-3">
        <div>
            <h2 class="fw-bold mb-0">Financial Records</h2>
            <p class="text-muted mb-0">Monitor student payments and outstanding balances</p>
        </div>
        <button class="btn btn-outline-success w-auto" onclick="downloadFeesExcel()">
            <i class="bi bi-file-earmark-spreadsheet me-2"></i> Export Ledger
        </button>
    </div>

    <div class="row g-3 mb-4 px-3">
        <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm bg-primary text-white p-3 rounded-4">
                <small class="opacity-75">Total Expected Revenue</small>
                <h3 id="total-revenue-amt" class="mb-0">$0.00</h3>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm bg-success text-white p-3 rounded-4">
                <small class="opacity-75">Total Collected</small>
                <h3 id="total-collected-amt" class="mb-0">$0.00</h3>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card border-0 shadow-sm bg-danger text-white p-3 rounded-4">
                <small class="opacity-75">Total Outstanding</small>
                <h3 id="total-due-amt" class="mb-0">$0.00</h3>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm mx-3 rounded-4 overflow-hidden">
        <div class="table-responsive-custom">
            <table class="table align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 sticky-col">Student Name</th>
                        <th>Total Fee</th>
                        <th>Paid</th>
                        <th>Remaining</th>
                        <th class="text-center pe-4">Status</th>
                    </tr>
                </thead>
                <tbody id="admin-fees-table">
                    </tbody>
            </table>
        </div>
    </div>
</section>


<section id="academic-section" class="d-none">
    <div class="p-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold">Academic History</h2>
            <div class="d-flex gap-2">
                <select id="academic-student-select" class="form-select" onchange="loadStudentAcademicRecords()" style="width: 250px;">
                    <option value="">Select a Student...</option>
                </select>
                <button class="btn btn-primary" onclick="openAddAcademicModal()">
                    <i class="bi bi-plus-circle me-2"></i>Add Record
                </button>
            </div>
        </div>

        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <table class="table align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Academic Year</th>
                        <th>Year Level</th>
                        <th>Course</th>
                        <th>Status</th>
                        <th class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody id="academic-table-body">
                    <tr><td colspan="5" class="text-center py-4 text-muted">Select a student to view records</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</section>



<section id="attendance-section" class="d-none section-fade">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 p-3 gap-3">
        <div>
            <h2 class="fw-bold mb-0">Attendance Management</h2>
            <p class="text-muted mb-0">Monitor student daily logs and geofencing verification</p>
        </div>
        <div class="d-flex gap-2">
            <input type="date" id="attendance-date-filter" class="form-control" onchange="fetchAttendanceAll()">
            <button class="btn btn-outline-primary" onclick="exportAttendance()"><i class="bi bi-download"></i></button>
        </div>
    </div>

    <div class="row g-3 mb-4 px-3">
        <div class="col-4"> <div class="card border-0 shadow-sm bg-success text-white p-2 p-md-3 rounded-4">
                <small class="opacity-75 d-block text-truncate">Present</small>
                <h3 id="stat-present" class="mb-0 fs-5 fs-md-3">0</h3>
            </div>
        </div>
        <div class="col-4">
            <div class="card border-0 shadow-sm bg-danger text-white p-2 p-md-3 rounded-4">
                <small class="opacity-75 d-block text-truncate">Absent</small>
                <h3 id="stat-absent" class="mb-0 fs-5 fs-md-3">0</h3>
            </div>
        </div>
        <div class="col-4">
            <div class="card border-0 shadow-sm bg-warning text-white p-2 p-md-3 rounded-4">
                <small class="opacity-75 d-block text-truncate">Late</small>
                <h3 id="stat-late" class="mb-0 fs-5 fs-md-3">0</h3>
            </div>
        </div>
    </div>

    <div class="px-3 mb-3 d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <div class="input-group bg-white shadow-sm rounded-3 overflow-hidden" style="max-width: 350px;">
            <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-search"></i></span>
            <input type="text" id="attendanceSearch" class="form-control border-0 shadow-none" 
                   placeholder="Search student..." onkeyup="filterAttendanceTable()">
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-success shadow-sm btn-sm py-2" onclick="downloadAttendanceExcel()">
                <i class="bi bi-file-earmark-spreadsheet"></i> <span class="d-none d-md-inline">Export</span>
            </button>
            <button class="btn btn-outline-primary shadow-sm btn-sm py-2" onclick="generateMonthlyReport()">
                <i class="bi bi-graph-up-arrow"></i> <span class="d-none d-md-inline">Monthly Stats</span>
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mx-3 rounded-4 overflow-hidden">
        <div class="table-responsive-custom">
            <table class="table align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4 sticky-col">Student</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Location (Address)</th>
                        <th class="text-center">GPS</th>
                        <th class="text-center pe-4">Action</th>
                    </tr>
                </thead>
                <tbody id="attendance-table-body">
                    </tbody>
            </table>
        </div>
    </div>
</section>
        <section id="marksSection" class="hidden section-fade">
            <div class="row mb-4 align-items-center">
                <div class="col">
                    <button onclick="showSection('students')" class="btn btn-link text-primary fw-bold text-decoration-none ps-0">
    <i class="bi bi-arrow-left me-2"></i> Back to Database
</button>
                </div>
                <div class="col-auto">
                    <div class="bg-primary rounded-4 px-4 py-3 text-white shadow-lg d-flex align-items-center">
                        <div class="me-3"><small class="d-block opacity-75">Average Score</small><h4 id="avgScore" class="fw-bold mb-0">0%</h4></div>
                        <i class="bi bi-graph-up fs-3"></i>
                    </div>
                </div>
            </div>

            <div class="card p-5 border-0 shadow-sm rounded-5">
                <div class="row align-items-center mb-5">
                    <div class="col">
                        <h3 class="fw-bold mb-1" id="currentStudentName">Student Name</h3>
                        <p class="text-muted mb-0"><i class="bi bi-journal-text me-2"></i>Detailed Academic Transcript</p>
                    </div>
                    <div class="col-auto">
                        <button onclick="openAddMarksModal()" class="btn btn-primary rounded-3 fw-bold px-4">
                            <i class="bi bi-plus-lg me-2"></i> Add Record
                        </button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table w-100">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Exam Type</th>
                                <th>Obtained Score</th>
                                <th>Status</th>
                                <th class="text-end pe-4">Options</th>
                            </tr>
                        </thead>
                        <tbody id="marksTableBody" class="small">
                            </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <div id="marksModal" class="custom-modal-overlay hidden">
        <div class="bg-white w-100 mx-3 rounded-5 shadow-2xl p-4 p-md-5" style="max-width: 500px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 id="marksModalTitle" class="fw-bold mb-0">Enter Grade</h4>
                <button class="btn-close" onclick="toggleMarksModal(false)"></button>
            </div>
            <form id="marksForm" class="row g-4">
                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">SUBJECT NAME</label>
                    <input type="text" id="m_subject" placeholder="e.g. Computer Science" class="form-control p-3 bg-light border-0 rounded-4" required>
                </div>
                <div class="col-12">
                    <label class="form-label small fw-bold text-muted">EXAMINATION CATEGORY</label>
                    <select id="m_testType" class="form-select p-3 bg-light border-0 rounded-4">
                        <option value="Midterm">Midterm</option>
                        <option value="Final Exam">Final Exam</option>
                        <option value="Unit Test">Unit Test</option>
                        <option value="Assignment">Assignment</option>
                    </select>
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold text-muted">OBTAINED</label>
                    <input type="number" id="m_obtained" placeholder="Score" class="form-control p-3 bg-light border-0 rounded-4" required>
                </div>
                <div class="col-6">
                    <label class="form-label small fw-bold text-muted">OUT OF</label>
                    <input type="number" id="m_outOf" placeholder="Max" class="form-control p-3 bg-light border-0 rounded-4" required>
                </div>
                <div class="col-12 pt-3">
                    <button type="submit" class="btn btn-primary btn-lg w-100 rounded-4 shadow-lg fw-bold">
                        Confirm Record
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fade" id="registrationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg rounded-4">
                <div class="modal-header border-0 pt-4 px-4">
                    <h5 class="modal-title fw-bold">Register Student</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="regForm" onsubmit="handleRegistration(event)" class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Full Name</label>
                            <input type="text" id="reg-name" class="form-control p-3 bg-light border-0 rounded-3" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Email Address</label>
                            <input type="email" id="reg-email" class="form-control p-3 bg-light border-0 rounded-3" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Phone Number</label>
                            <input type="text" id="reg-phone" class="form-control p-3 bg-light border-0 rounded-3">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Date of Birth</label>
                            <input type="date" id="reg-dob" class="form-control p-3 bg-light border-0 rounded-3">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Course/Major</label>
                            <input type="text" id="reg-course" class="form-control p-3 bg-light border-0 rounded-3">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Current Year</label>
                            <select id="reg-year" class="form-select p-3 bg-light border-0 rounded-3">
                                <option value="1">Year 1</option>
                                <option value="2">Year 2</option>
                                <option value="3">Year 3</option>
                                <option value="4">Year 4</option>
                            </select>
                        </div>
                        <div class="col-md-6" id="passField">
                            <label class="form-label small fw-bold">Set Password</label>
                            <input type="password" id="reg-pass" class="form-control p-3 bg-light border-0 rounded-3">
                        </div>
                        <div class="col-12 mt-4">
                            <button type="submit" class="btn btn-primary w-100 p-3 fw-bold rounded-3">Process Student Profile</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
<div class="modal fade" id="facultyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold" id="facultyModalLabel">Faculty Member Profile</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <form id="facultyForm" onsubmit="handleFacultySubmit(event)">
                    <input type="hidden" id="f-id">
                    
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">FACULTY ID (UNIQUE)</label>
                            <input type="text" id="f-facultyId" class="form-control p-3 bg-light border-0 rounded-3 shadow-none" placeholder="e.g. FAC-1001" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">FULL NAME</label>
                            <input type="text" id="f-name" class="form-control p-3 bg-light border-0 rounded-3 shadow-none" placeholder="Enter full name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">EMAIL ADDRESS</label>
                            <input type="email" id="f-email" class="form-control p-3 bg-light border-0 rounded-3 shadow-none" placeholder="name@college.edu" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">DEPARTMENT / SPECIALIZATION</label>
                            <input type="text" id="f-subject" class="form-control p-3 bg-light border-0 rounded-3 shadow-none" placeholder="e.g. Computer Science" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">RANK / OCCUPATION</label>
                            <select id="f-occupation" class="form-select p-3 bg-light border-0 rounded-3 shadow-none">
                                <option value="Professor">Professor</option>
                                <option value="Associate Professor">Associate Professor</option>
                                <option value="Assistant Professor">Assistant Professor</option>
                                <option value="Lecturer">Lecturer</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted">ANNUAL SALARY</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0 px-3">$</span>
                                <input type="number" id="f-salary" class="form-control p-3 bg-light border-0 rounded-end shadow-none" placeholder="0.00">
                            </div>
                        </div>
                        <div class="col-12" id="f-password-group">
                            <label class="form-label small fw-bold text-muted">TEMPORARY PASSWORD</label>
                            <input type="password" id="f-password" class="form-control p-3 bg-light border-0 rounded-3 shadow-none" placeholder="Min. 8 characters">
                            <small class="text-muted">Password is only required for new registrations.</small>
                        </div>
                    </div>

                    <div class="mt-5">
                        <button type="submit" id="facultySubmitBtn" class="btn btn-primary w-100 p-3 fw-bold rounded-3 shadow">
                            Save Faculty Record
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="viewStudentsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">Students Assigned to <span id="view-faculty-name" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="input-group mb-3 bg-light rounded-3 overflow-hidden">
                    <span class="input-group-text bg-transparent border-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="modalStudentSearch" class="form-control border-0 bg-transparent shadow-none" 
                           placeholder="Filter students by name or ID..." onkeyup="filterModalStudents()">
                </div>

                <div id="assigned-students-list" style="max-height: 400px; overflow-y: auto;">
                    </div>
            </div>
            <div class="modal-footer border-0 pb-4 px-4">
                <button class="btn btn-outline-success w-100 rounded-3 fw-bold" onclick="exportModalStudentsToExcel()">
                    <i class="bi bi-file-earmark-spreadsheet me-2"></i> Export This List
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">Payment History: <span id="fee-student-name" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-3 mb-4 p-3 bg-light rounded-3">
                    <div class="col-md-5">
                        <label class="small fw-bold">Update Total Course Fee</label>
                        <input type="number" id="update-total-amt" class="form-control">
                    </div>
                    <div class="col-md-5">
                        <label class="small fw-bold">Update Exam Fees</label>
                        <input type="number" id="update-exam-amt" class="form-control">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-dark w-100" onclick="saveBilling()">Save</button>
                    </div>
                </div>

                <h6>Add New Payment</h6>
                <div class="input-group mb-4">
                    <span class="input-group-text">$</span>
                    <input type="number" id="new-payment-amt" class="form-control" placeholder="Enter amount">
                    <button class="btn btn-success" onclick="processPayment()">Post Payment</button>
                </div>

                <table class="table table-sm border">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Amount Paid</th>
                            <th class="text-end">Action</th>
                        </tr>
                    </thead>
                    <tbody id="payment-history-list"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="attendanceReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0">
    <h5 class="fw-bold">Monthly Attendance Overview</h5>
    <div class="ms-auto">
        <button class="btn btn-sm btn-success me-2" onclick="downloadMonthlyExcel()">
            <i class="bi bi-file-earmark-spreadsheet me-1"></i> Download CSV
        </button>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
</div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table align-middle">
                        <thead>
                            <tr class="text-muted">
                                <th>Student</th>
                                <th>Total Days</th>
                                <th>Present</th>
                                <th>Percentage</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="monthly-report-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="academicModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow rounded-4">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold" id="academicModalTitle">Add Academic Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="academicForm">
                    <input type="hidden" id="recordId">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Academic Year (e.g. 2023-2024)</label>
                        <input type="text" id="ac-acadYear" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label class="form-label small text-muted">Current Year (1-4)</label>
                            <input type="number" id="ac-currYear" class="form-control" required>
                        </div>
                        <div class="col">
                            <label class="form-label small text-muted">Status</label>
                            <select id="ac-status" class="form-select">
                                <option value="Pass">Pass</option>
                                <option value="Fail">Fail</option>
                                <option value="Ongoing">Ongoing</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Course Name</label>
                        <input type="text" id="ac-course" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2 rounded-3">Save Record</button>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // CONFIGURATION
        const BASE_URL = 'https://smart-college.onrender.com';
        const HEADERS = {
            'X-API-KEY': 'StudentApiKey123', // MATCH YOUR INTERCEPTOR KEY
            'Content-Type': 'application/json'
        };
        let allStudents = [];
        let editMode = false;
        let currentEditId = null;
        let activeStudentId = null;
        let currentMarksEditId = null;
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const adminName = localStorage.getItem('adminName');
            if(!adminName) window.location.href = "admin-auth.html";
            document.getElementById('admin-name').innerText = adminName;
            loadAssignmentData();
        });

        /**
         * Handles navigation between dashboard sections.
         * Optimized to handle both Bootstrap 'd-none' and custom 'hidden' classes.
         */
         function showSection(section) {
        	    const sections = [
        	        'overview-section', 
        	        'assign-section', 
        	        'manage-students-section', 
        	        'manage-faculty-section', 
        	        'marksSection',
        	        'manage-fees-section',
        	        'attendance-section',
        	        'academic-section' 
        	    ];
        	    // 2. Hide all sections
        	    sections.forEach(id => {
        	        const el = document.getElementById(id);
        	        if (el) el.classList.add('hidden', 'd-none');
        	    });

        	    // 3. Reset Sidebar Links
document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        	    
        	    // 4. Activate selected section logic
        	    if (section === 'overview') {
        	        document.getElementById('overview-section').classList.remove('hidden', 'd-none');
        	        document.getElementById('nav-overview').classList.add('active');
        	        loadDashboardCounts();
        	    } else if (section === 'faculty') {
        	        document.getElementById('manage-faculty-section').classList.remove('hidden', 'd-none');
        	        document.getElementById('nav-faculty').classList.add('active');
        	        fetchFaculties(); 
        	    } else if (section === 'students') {
        	        document.getElementById('manage-students-section').classList.remove('hidden', 'd-none');
        	        document.getElementById('nav-students').classList.add('active');
        	        fetchAllStudents();
        	    } else if (section === 'assign') {
        	        document.getElementById('assign-section').classList.remove('hidden', 'd-none');
        	        document.getElementById('nav-assign').classList.add('active');
        	        loadAssignmentData();
        	    } else if (section === 'fees') {
        	        document.getElementById('manage-fees-section').classList.remove('hidden', 'd-none');
        	        const navFees = document.getElementById('nav-fees');
        	        if (navFees) navFees.classList.add('active');
        	        fetchFeesLedger();
        	    } 
        	    // NEW ATTENDANCE LOGIC
        	    if (section === 'academic') {
        const sectionEl = document.getElementById('academic-section');
        const navLink = document.getElementById('nav-academic');
        
        if (sectionEl) sectionEl.classList.remove('hidden', 'd-none');
        if (navLink) navLink.classList.add('active');
        
        fetchStudentsForAcademic(); // Populate the student dropdown
    }
        	    else if (section === 'attendance') {
        	        document.getElementById('attendance-section').classList.remove('hidden', 'd-none');
        	        const navAtt = document.getElementById('nav-attendance');
        	        if (navAtt) navAtt.classList.add('active');
        	        fetchAttendanceAll(); // This function loads the attendance data from API
        	    }
        	   
        	}
         function updateSwitchButtons(activeSection) {
        	    const btnStudent = document.getElementById('switch-to-students');
        	    const btnFaculty = document.getElementById('switch-to-faculty');
        	    const btnFees = document.getElementById('switch-to-fees'); // Optional extra button

        	    // Reset all to light
        	    [btnStudent, btnFaculty, btnFees].forEach(btn => {
        	        if(btn) btn.classList.replace('btn-primary', 'btn-light');
        	        if(btn) btn.classList.remove('shadow-sm');
        	    });

        	    // Highlight the active one
        	    let activeBtn;
        	    if (activeSection === 'students') activeBtn = btnStudent;
        	    else if (activeSection === 'faculty') activeBtn = btnFaculty;
        	    else if (activeSection === 'fees') activeBtn = btnFees;

        	    if (activeBtn) {
        	        activeBtn.classList.replace('btn-light', 'btn-primary');
        	        activeBtn.classList.add('shadow-sm');
        	    }
        	}

        	// Add this line inside your existing showSection(section) function:
        	// if (section === 'students' || section === 'faculty') updateSwitchButtons(section);
        // LOAD COUNTS AND DROPDOWNS
      async function loadAssignmentData() {
    try {
        // 1. Fetch Faculty (Needed for the dropdown)
        const fRes = await fetch(`${BASE_URL}/api/faculty`, { headers: HEADERS });
        const faculties = await fRes.json();
        const fDrop = document.getElementById('faculty-dropdown');
        fDrop.innerHTML = '<option value="">Select Professor...</option>';
        faculties.forEach(f => {
            fDrop.innerHTML += `<option value="${f.id}">${f.name} - ${f.subject}</option>`;
        });
        document.getElementById('total-faculty').innerText = faculties.length;

        // 2. Fetch Students
        const sRes = await fetch(`${BASE_URL}/college/students`, { headers: HEADERS });
        const students = await sRes.json();
        const sMulti = document.getElementById('student-multiselect');
        sMulti.innerHTML = '';

        students.forEach(s => {
            // FIXED: Using s.studId to match your Java @Id field
            const actualId = s.studId; 
            const name = s.fullName || "Unnamed Student";

            if (actualId) {
                sMulti.innerHTML += `<option value="${actualId}">${name} (${s.email})</option>`;
            }
        });
        document.getElementById('total-students').innerText = students.length;

    } catch (err) {
        console.error("Data Load Error:", err);
    }
}

        // FETCH ALL STUDENTS FOR TABLE
   // FETCH STUDENTS (INCLUDING FACULTY_ID)
async function fetchAllStudents() {
    try {
        const res = await fetch(`${BASE_URL}/college/students`, { headers: HEADERS });
        const students = await res.json();
        allStudents = students; // Store globally for editing
        
        const tableBody = document.getElementById('admin-student-table');
        tableBody.innerHTML = '';

        students.forEach((s, index) => {
            const facultyId = s.faculty ? (s.faculty.id || s.faculty.facultyId) : 'Unassigned';
            
            tableBody.innerHTML += `
                <tr>
                    <td class="ps-4 fw-bold text-muted">#${s.studId}</td>
                    <td class="fw-bold">${s.fullName}</td>
                    <td class="small">${s.email}</td>
                    <td>${s.phoneNo || '-'}</td>
                    <td><span class="badge bg-light text-dark border">${s.course}</span></td>
                    <td>
                        <span class="badge ${facultyId !== 'Unassigned' ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'}">
                            ${facultyId !== 'Unassigned' ? 'FID: ' + facultyId : 'Unassigned'}
                        </span>
                    </td>
                    <td class="pe-4 text-center">
                        <div class="btn-group">
                        <button onclick="openMarksManagement(${s.studId}, '${s.fullName}')" class="btn btn-sm btn-outline-success me-2" title="Academic Performance">
                        <i class="fas fa-poll"></i>
                    </button>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="openEditModal(${index})">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${s.studId})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });
    } catch (err) { console.error("Fetch Error:", err); }
}
//Global variables to track state


function openEditModal(index) {
    const student = allStudents[index];
    editMode = true;
    currentEditId = student.studId;

    const modalTitle = document.querySelector('#registrationModal h5');
    const submitBtn = document.querySelector('#registrationModal button[type="submit"]');
    const passInput = document.getElementById('reg-pass');
    const passField = passInput.closest('.col-md-6');

    // UI Updates
    modalTitle.innerText = "Update Academic Profile";
    submitBtn.innerText = "Update Student Data";
    
    // FIX FOR "NOT FOCUSABLE" ERROR:
    // Hide the field AND remove 'required' so the browser allows submission
    passField.classList.add('d-none');
    passInput.removeAttribute('required');

    // Fill Data
    document.getElementById('reg-name').value = student.fullName || "";
    document.getElementById('reg-email').value = student.email || "";
    document.getElementById('reg-email').disabled = true; 
    document.getElementById('reg-phone').value = student.phoneNo || "";
    document.getElementById('reg-dob').value = student.dob || "";
    document.getElementById('reg-course').value = student.course || "";
    document.getElementById('reg-year').value = student.year || 1;

    const modal = new bootstrap.Modal(document.getElementById('registrationModal'));
    modal.show();
}

async function handleRegistration(event) {
    event.preventDefault();

    // Collect data
    const data = {
        fullName: document.getElementById('reg-name').value,
        phoneNo: document.getElementById('reg-phone').value,
        dob: document.getElementById('reg-dob').value,
        course: document.getElementById('reg-course').value,
        year: parseInt(document.getElementById('reg-year').value) || 1
    };

    if (!editMode) {
        data.email = document.getElementById('reg-email').value;
        data.password = document.getElementById('reg-pass').value;
    }

    const url = editMode 
        ? `${BASE_URL}/college/students/${currentEditId}` 
        : `${BASE_URL}/college/students/register`;
    
    const method = editMode ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            headers: HEADERS,
            body: JSON.stringify(data)
        });

        if (res.ok) {
            alert(editMode ? " Updated Successfully!" : " Registered Successfully!");
            // Instead of reload, just close and refresh table to avoid storage issues
            bootstrap.Modal.getInstance(document.getElementById('registrationModal')).hide();
            fetchAllStudents(); 
        } else {
            const errText = await res.text();
            alert(" Server Error: " + errText);
        }
    } catch (err) {
        console.error("Fetch error:", err);
        alert(" Failed to connect to server.");
    }
}
        async function processAssignment() {
            const facultyId = document.getElementById('faculty-dropdown').value;
            const selectEl = document.getElementById('student-multiselect');
            
            // Extract highlighted values
            const selectedIds = Array.from(selectEl.selectedOptions)
                                     .map(option => parseInt(option.value)) // Ensure numbers
                                     .filter(id => !isNaN(id));

            if (!facultyId) return alert(" Please select a Faculty member first.");
            if (selectedIds.length === 0) return alert(" Please highlight at least one student from the list.");

            try {
                const response = await fetch(`${BASE_URL}/api/faculty/${facultyId}/assign-students`, {
                    method: 'POST',
                    headers: HEADERS,
                    body: JSON.stringify(selectedIds) 
                });

                if (response.ok) {
                    alert(" Students successfully linked to Faculty!");
                    showSection('overview'); // Go back to dashboard
                } else {
                    alert(" Server Error: " + await response.text());
                }
            } catch (err) {
                alert(" Connection failed. Is the backend running?");
            }
        }
        function filterStudents() {
            const searchTerm = document.getElementById('studentFilter').value.toLowerCase();
            const options = document.getElementById('student-multiselect').options;
            for (let opt of options) {
                opt.style.display = opt.text.toLowerCase().includes(searchTerm) ? "" : "none";
            }
        }

        async function deleteStudent(studId) {
            // 1. Double check the ID exists
            if (!studId) {
                console.error("Delete failed: No Student ID provided");
                return;
            }

            if (confirm(`Are you sure you want to delete Student #${studId}?`)) {
                try {
                    const res = await fetch(`${BASE_URL}/college/students/${studId}`, { 
                        method: 'DELETE',
                        headers: HEADERS // Important: Your Interceptor needs the API Key
                    });

                    if (res.ok) {
                        alert(" Student deleted successfully");
                        fetchAllStudents(); // Refresh the table
                    } else {
                        const errorMsg = await res.text();
                        alert(" Delete failed: " + errorMsg);
                    }
                } catch (err) {
                    console.error("Delete Error:", err);
                    alert(" Connection error. Is the server running?");
                }
            }
        }
       
        // Reset modal when it's closed
      // Reset everything when closing the modal
document.getElementById('registrationModal').addEventListener('hidden.bs.modal', function () {
    editMode = false;
    currentEditId = null;
    const passInput = document.getElementById('reg-pass');
    
    document.getElementById('regForm').reset();
    document.getElementById('reg-email').disabled = false;
    
    // Restore required attribute for new registrations
    passInput.setAttribute('required', ''); 
    document.getElementById('reg-pass').closest('.col-md-6').classList.remove('d-none');
    document.querySelector('#registrationModal h5').innerText = "Create Academic Profile";
});
        
       /// ///marks



// 1. Switch to the Marks View
function openMarksManagement(studId, name) {
    activeStudentId = studId;
    document.getElementById('currentStudentName').innerText = name;
    
    // Hide the Student List
    const studentList = document.getElementById('manage-students-section');
    studentList.classList.add('hidden');
    studentList.classList.add('d-none');
    
    // Show the Marks Section
    const marksSec = document.getElementById('marksSection');
    marksSec.classList.remove('hidden');
    marksSec.classList.remove('d-none');
    
    document.getElementById('pageTitle').innerText = 'Academic Performance';
    document.getElementById('breadcrumb-current').innerText = 'Student Marks';

    loadStudentMarks(studId);
}

// 2. Load Marks for Active Student
async function loadStudentMarks(studId) {
    try {
        const res = await fetch(`${BASE_URL}/college/marks/student/${studId}`, { 
            headers: HEADERS 
        });
        const marks = await res.json();
        const body = document.getElementById('marksTableBody');
        
        let totalPercent = 0;
        body.innerHTML = marks.length > 0 ? '' : '<tr><td colspan="5" class="py-10 text-center text-slate-400">No marks found for this student.</td></tr>';

        marks.forEach(m => {
            const percent = ((m.obtainedMarks / m.outOf) * 100).toFixed(1);
            totalPercent += parseFloat(percent);
            const colorClass = percent >= 40 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';

            body.innerHTML += `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition">
                    <td class="py-5 px-2 font-semibold text-slate-700">${m.subject}</td>
                    <td class="py-5 px-2 text-slate-500">${m.testType}</td>
                    <td class="py-5 px-2 text-slate-700 font-medium">${m.obtainedMarks} / ${m.outOf}</td>
                    <td class="py-5 px-2">
                        <span class="px-3 py-1 rounded-full text-xs font-bold ${colorClass}">${percent}%</span>
                    </td>
                    <td class="py-5 px-2 text-right">
                        <button onclick='editMarkRecord(${JSON.stringify(m)})' class="text-indigo-400 hover:text-indigo-600 mr-3"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteMarkRecord(${m.marksId})" class="text-slate-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
        });

        const avg = marks.length > 0 ? (totalPercent / marks.length).toFixed(1) : 0;
        document.getElementById('avgScore').innerText = avg + "%";
    } catch (err) { console.error("Error loading marks:", err); }
}

// 3. Save Marks (POST/PUT)
// 3. Save Marks (POST/PUT)
document.getElementById('marksForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Collect data from the improved HTML IDs
    const data = {
        subject: document.getElementById('m_subject').value,
        testType: document.getElementById('m_testType').value,
        obtainedMarks: parseFloat(document.getElementById('m_obtained').value),
        outOf: parseFloat(document.getElementById('m_outOf').value)
    };

    // Determine if we are updating or creating
    const method = currentMarksEditId ? 'PUT' : 'POST';
    const url = currentMarksEditId 
        ? `${BASE_URL}/college/marks/${currentMarksEditId}` 
        : `${BASE_URL}/college/marks/${activeStudentId}`;

    try {
        const res = await fetch(url, {
            method: method,
            headers: HEADERS,
            body: JSON.stringify(data)
        });

        if (res.ok) {
            toggleMarksModal(false); // Close the modal
            loadStudentMarks(activeStudentId); // Refresh the list
            alert(" Academic record saved!");
        } else {
            alert(" Failed to save: " + await res.text());
        }
    } catch (err) {
        console.error("Save Error:", err);
    }
});

// Modal Helpers
function toggleMarksModal(show) {
    const modal = document.getElementById('marksModal');
    if(show) {
        modal.classList.remove('hidden'); // Remove the 'hidden' class we added in CSS
        // Small timeout to allow the transition/fade effect to trigger
        setTimeout(() => modal.style.opacity = "1", 10);
    } else {
        modal.style.opacity = "0";
        setTimeout(() => modal.classList.add('hidden'), 300);
    }
}

function openAddMarksModal() {
    currentMarksEditId = null;
    document.getElementById('marksForm').reset();
    document.getElementById('marksModalTitle').innerText = "Add New Record";
    toggleMarksModal(true);
}

function editMarkRecord(m) {
    currentMarksEditId = m.marksId;
    document.getElementById('marksModalTitle').innerText = "Update Record";
    document.getElementById('m_subject').value = m.subject;
    document.getElementById('m_testType').value = m.testType;
    document.getElementById('m_obtained').value = m.obtainedMarks;
    document.getElementById('m_outOf').value = m.outOf;
    toggleMarksModal(true);
}

async function deleteMarkRecord(id) {
    if(confirm("Delete this academic record?")) {
        await fetch(`${BASE_URL}/college/marks/${id}`, { method: 'DELETE', headers: HEADERS });
        loadStudentMarks(activeStudentId);
    }
}
/**
 * 1. FETCH ALL FACULTY
 * Renders the faculty directory table
 */
async function fetchFaculties() {
    const tableBody = document.getElementById('admin-faculty-table');
    
    try {
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4"><div class="spinner-border text-primary spinner-border-sm"></div> Fetching staff...</td></tr>';

        const response = await fetch(`${BASE_URL}/api/faculty`, { headers: HEADERS });
        if (!response.ok) throw new Error("Could not connect to Faculty API");
        
        const faculties = await response.json();
        tableBody.innerHTML = ''; 

        if (faculties.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No faculty members registered.</td></tr>';
            return;
        }

        faculties.forEach(f => {
            tableBody.innerHTML += `
                <tr class="section-fade">
                    <td class="ps-4"><span class="badge bg-primary-subtle text-primary px-3">#${f.facultyId || f.id}</span></td>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-indigo text-white rounded-circle p-2 me-3 d-flex align-items-center justify-content-center" style="width:35px; height:35px; background: #4f46e5;">
                                <i class="bi bi-person-fill small"></i>
                            </div>
                            <div>
                                <div class="fw-bold text-dark">${f.name}</div>
                                <div class="text-muted small">${f.email}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="text-secondary fw-semibold">${f.subject}</span></td>
                    <td><small class="text-uppercase tracking-wider fw-bold text-muted" style="font-size:0.7rem;">${f.occupation || 'Staff'}</small></td>
                    <td><span class="fw-bold text-success">$${f.salary ? f.salary.toLocaleString() : '0'}</span></td>
                    <td class="text-center pe-4">
                        <div class="btn-group shadow-sm rounded-3">
                            <button class="btn btn-sm btn-white border" onclick="viewAssignedStudents(${f.id}, '${f.name}')" title="View Students">
                                <i class="bi bi-eye text-info"></i>
                            </button>
                            <button class="btn btn-sm btn-white border" onclick="editFaculty(${f.id})" title="Edit Profile">
                                <i class="bi bi-pencil-square text-primary"></i>
                            </button>
                            <button class="btn btn-sm btn-white border" onclick="deleteFaculty(${f.id})" title="Delete Account">
                                <i class="bi bi-trash3 text-danger"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
        });

        const countEl = document.getElementById('total-faculty');
        if (countEl) countEl.innerText = faculties.length;

    } catch (error) {
        console.error("Faculty Fetch Error:", error);
        tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-danger">Error: ${error.message}</td></tr>`;
    }
}

/**
 * 2. VIEW ASSIGNED STUDENTS
 * Fetches and shows students in a modal with search/filter
 */
async function viewAssignedStudents(facultyId, facultyName) {
    document.getElementById('view-faculty-name').innerText = facultyName;
    const list = document.getElementById('assigned-students-list');
    
    list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div></div>';
    
    const modal = new bootstrap.Modal(document.getElementById('viewStudentsModal'));
    modal.show();

    try {
        const res = await fetch(`${BASE_URL}/api/faculty/${facultyId}/students`, { headers: HEADERS });
        const students = await res.json();

        list.innerHTML = '';
        if (students.length === 0) {
            list.innerHTML = '<p class="text-center text-muted py-4">No students currently assigned.</p>';
        } else {
            students.forEach(s => {
                list.innerHTML += `
                    <div class="student-row d-flex justify-content-between align-items-center p-3 mb-2 bg-light rounded-3">
                        <div>
                            <p class="mb-0 fw-bold">${s.fullName}</p>
                            <small class="text-muted">${s.course} | ID: ${s.studId}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-primary rounded-pill" onclick="quickReassign(${s.studId})">Reassign</button>
                    </div>`;
            });
        }
    } catch (err) {
        list.innerHTML = '<p class="text-danger">Failed to load students.</p>';
    }
}

/**
 * 3. MODAL FILTERING & NAVIGATION
 */
function filterModalStudents() {
    const term = document.getElementById('modalStudentSearch').value.toLowerCase();
    const rows = document.getElementsByClassName('student-row');
    Array.from(rows).forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(term) ? "flex" : "none";
    });
}

function goToReassign() {
    const modalEl = document.getElementById('viewStudentsModal');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if(modalInstance) modalInstance.hide();
    showSection('assign');
}

function quickReassign(studentId) {
    const modalEl = document.getElementById('viewStudentsModal');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if(modalInstance) modalInstance.hide();
    showSection('assign');
    alert("Reassign Mode: Find Student ID #" + studentId + " and pick a new Faculty.");
}

/**
 * 4. CRUD OPERATIONS (SUBMIT, EDIT, DELETE)
 */
async function handleFacultySubmit(event) {
    event.preventDefault();

    const id = document.getElementById('f-id').value; 
    const facultyData = {
        facultyId: document.getElementById('f-facultyId').value,
        name: document.getElementById('f-name').value,
        email: document.getElementById('f-email').value,
        subject: document.getElementById('f-subject').value,
        occupation: document.getElementById('f-occupation').value,
        salary: parseFloat(document.getElementById('f-salary').value) || 0
    };

    const pass = document.getElementById('f-password').value;
    if (pass) facultyData.password = pass;

    // Fixed path logic to match your Controller
    let url = id ? `${BASE_URL}/api/faculty/${id}/update-profile` : `${BASE_URL}/api/faculty/register`;
    let method = id ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: HEADERS,
            body: JSON.stringify(facultyData)
        });

        if (response.ok) {
            alert(id ? " Profile Updated!" : " Registered Successfully!");
            const modalEl = document.getElementById('facultyModal');
            bootstrap.Modal.getInstance(modalEl).hide();
            fetchFaculties(); 
        } else {
            alert(" Save failed: " + await response.text());
        }
    } catch (error) {
        console.error("Submission error:", error);
    }
}

async function editFaculty(id) {
    try {
        const response = await fetch(`${BASE_URL}/api/faculty/${id}`, { headers: HEADERS });
        const f = await response.json();

        document.getElementById('f-id').value = f.id; 
        document.getElementById('f-facultyId').value = f.facultyId;
        document.getElementById('f-name').value = f.name;
        document.getElementById('f-email').value = f.email;
        document.getElementById('f-subject').value = f.subject;
        document.getElementById('f-occupation').value = f.occupation;
        document.getElementById('f-salary').value = f.salary;

        document.getElementById('facultyModalLabel').innerText = "Update Profile: " + f.name;
        document.getElementById('f-password-group').classList.add('d-none'); 
        
        new bootstrap.Modal(document.getElementById('facultyModal')).show();
    } catch (err) {
        alert(" Error: Could not load faculty data.");
    }
}

async function deleteFaculty(id) {
    if (!confirm("Are you sure? This will permanently remove this record.")) return;

    // Reassign check to avoid SQL FK errors
    const isSafe = await reassignAndCleanup(id);
    if (!isSafe) return; 

    try {
        const response = await fetch(`${BASE_URL}/api/faculty/${id}`, {
            method: 'DELETE',
            headers: HEADERS
        });

        if (response.ok) {
            alert(" Faculty removed.");
            fetchFaculties(); 
        } else {
            alert(" Server rejected request: " + await response.text());
        }
    } catch (err) {
        alert(" Network Error.");
    }
}

/**
 * 5. UTILITY FUNCTIONS (SEARCH, EXCEL, RESET)
 */
function filterTableData() {
    const input = document.getElementById("globalSearch");
    const filter = input.value.toLowerCase();
    
    const isStudentView = !document.getElementById('manage-students-section').classList.contains('d-none');
    const tableId = isStudentView ? "admin-student-table" : "admin-faculty-table";
    
    const rows = document.getElementById(tableId).getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
        rows[i].style.display = rows[i].textContent.toLowerCase().includes(filter) ? "" : "none";
    }
}
async function downloadFacultyExcel() {
    try {
    	
        const response = await fetch(`${BASE_URL}/api/faculty`, { headers: HEADERS });
        const faculties = await response.json();
        console.log("Raw Backend Data:", faculties); // Check if 'students' array exists here
        const excelRows = faculties.map(f => ({
            "Staff Code": f.facultyId,
            "Full Name": f.name,
            "Email": f.email,
            "Department": f.subject,
            "Salary": f.salary,
            // f.students will now contain the list thanks to JOIN FETCH
            "Students Assigned": (f.students && Array.isArray(f.students)) ? f.students.length : 0
        }));

        const worksheet = XLSX.utils.json_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Faculty_Staff");
        XLSX.writeFile(workbook, `Faculty_Report_${new Date().toLocaleDateString()}.xlsx`);
    } catch (e) {
        alert("Excel Error: " + e.message);
    }
}

async function downloadAssignmentReport() {
    try {
        // Fetch students directly because they contain the faculty reference
        const response = await fetch(`${BASE_URL}/api/students`, { headers: HEADERS });
        const students = await response.json();

        const reportData = students.map(s => ({
            "Student Name": s.fullName,
            "Student ID": s.studId,
            "Course": s.course,
            "Assigned Mentor": s.faculty ? s.faculty.name : "Unassigned",
            "Mentor Dept": s.faculty ? s.faculty.subject : "N/A"
        }));

        const worksheet = XLSX.utils.json_to_sheet(reportData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Assignments");
        XLSX.writeFile(workbook, "Student_Mentor_Assignments.xlsx");
    } catch (e) {
        alert("Assignment Export Error: " + e.message);
    }
}
async function exportModalStudentsToExcel() {
    // 1. Check if XLSX library is actually loaded
    if (typeof XLSX === 'undefined') {
        alert("Excel library not loaded. Please add the SheetJS script tag to your HTML.");
        return;
    }

    const facultyName = document.getElementById('view-faculty-name').innerText;
    const listItems = document.getElementById('assigned-students-list').getElementsByClassName('student-row');
    
    if (listItems.length === 0) {
        alert("No students found to export!");
        return;
    }

    try {
        // 2. Map the data from the UI rows into a clean array
        const data = Array.from(listItems).map(row => {
            const name = row.querySelector('p.fw-bold').innerText;
            const details = row.querySelector('small.text-muted').innerText.split('|');
            return {
                "Student Name": name,
                "Course": details[0] ? details[0].trim() : "N/A",
                "Student ID": details[1] ? details[1].replace('ID:', '').trim() : "N/A",
                "Assigned Faculty": facultyName
            };
        });

        // 3. Create the Excel structure
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Assigned Students");
        
        // 4. Trigger Download
        XLSX.writeFile(workbook, `${facultyName.replace(/\s+/g, '_')}_Student_List.xlsx`);
        
    } catch (err) {
        console.error("Export Error:", err);
        alert("Failed to generate Excel: " + err.message);
    }
}
async function reassignAndCleanup(oldFacultyId) {
    try {
        const res = await fetch(`${BASE_URL}/api/faculty/${oldFacultyId}/students`, { headers: HEADERS });
        const students = await res.json();
        if (students.length > 0) {
            alert(`Wait! This faculty has ${students.length} students. Reassign them first.`);
            showSection('assign'); 
            return false;
        }
        return true;
    } catch (err) { return false; }
}

function resetFacultyForm() {
    document.getElementById('facultyForm').reset();
    document.getElementById('f-id').value = '';
    document.getElementById('f-password-group').classList.remove('d-none');
    document.getElementById('facultyModalLabel').innerText = "Faculty Member Profile";
}

let currentSelectedStudId = null;

//Helper to find the most recent date in payment history
function getLatestPaymentDate(history) {
 if (!history || history.length === 0) return "No Records";
 const dates = history.map(h => new Date(h.paymentDate));
 const latest = new Date(Math.max(...dates));
 return latest.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
}

//1. Fetch Ledger, Calculate Stats, and Render Table
async function fetchFeesLedger() {
 const tableBody = document.getElementById('admin-fees-table');
 const revCard = document.getElementById('total-revenue-amt');
 const collCard = document.getElementById('total-collected-amt');
 const dueCard = document.getElementById('total-due-amt');

 try {
     const response = await fetch(`${BASE_URL}/college/fees/all`, { headers: HEADERS });
     const feesList = await response.json();
     
     tableBody.innerHTML = '';
     let [totalRev, totalColl, totalDue] = [0, 0, 0];

     feesList.forEach(f => {
         // Logic: Total Revenue should include exam fees if they are separate
         totalRev += (f.totalAmount + (f.examFees || 0));
         totalColl += f.paidAmount;
         totalDue += f.dueAmount;

         const lastDate = getLatestPaymentDate(f.paymentHistory);
         const percentage = f.totalAmount > 0 
             ? Math.min(Math.round((f.paidAmount / f.totalAmount) * 100), 100) 
             : 0;

         let barColor = 'bg-danger';
         if (percentage > 40) barColor = 'bg-warning';
         if (percentage >= 100) barColor = 'bg-success';

         tableBody.innerHTML += `
             <tr class="fees-row" data-due="${f.dueAmount}">
                 <td class="ps-4">
                     <div class="fw-bold text-dark">${f.student?.fullName || 'Unknown'}</div>
                     <div class="text-muted small">ID: #${f.student?.studId}</div>
                 </td>
                 <td>$${f.totalAmount.toLocaleString()}</td>
                 <td>
                     <div class="d-flex align-items-center">
                         <span class="me-2 fw-bold text-success">$${f.paidAmount.toLocaleString()}</span>
                         <small class="text-muted">(${percentage}%)</small>
                     </div>
                     <div class="progress" style="height: 6px; width: 100px;">
                         <div class="progress-bar ${barColor}" style="width: ${percentage}%"></div>
                     </div>
                 </td>
                 <td class="text-danger fw-bold">$${f.dueAmount.toLocaleString()}</td>
                 <td class="text-muted small">
                      <i class="bi bi-calendar3 me-1"></i> ${lastDate}
                 </td>
                 <td class="text-center pe-4">
                     <div class="d-flex justify-content-center gap-2">
                          <span class="badge ${f.dueAmount <= 0 ? 'bg-success-subtle text-success' : 'bg-warning-subtle text-warning'} rounded-pill px-3">
                             ${f.dueAmount <= 0 ? 'Cleared' : 'Due'}
                         </span>
                         <button class="btn btn-sm btn-light border shadow-sm" onclick="managePayments(${f.student.studId}, '${f.student.fullName}')">
                             <i class="bi bi-pencil-square text-primary"></i>
                         </button>
                         <button class="btn btn-sm btn-light border shadow-sm" onclick="generateInvoice(${f.student.studId}, '${f.student.fullName}', ${f.totalAmount}, ${f.paidAmount}, ${f.dueAmount})">
                             <i class="bi bi-printer text-dark"></i>
                         </button>
                     </div>
                 </td>
             </tr>`;
     });

     revCard.innerText = `$${totalRev.toLocaleString()}`;
     collCard.innerText = `$${totalColl.toLocaleString()}`;
     dueCard.innerText = `$${totalDue.toLocaleString()}`;

 } catch (err) {
     console.error("Ledger Fetch Error:", err);
     tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Connection Error.</td></tr>';
 }
}

//2. Export Ledger with Date Column correctly mapped
function downloadFeesExcel() {
 const table = document.getElementById("admin-fees-table");
 const rows = table.querySelectorAll("tr");
 let csv = ["Student Name,Total Fee,Paid,Remaining,Last Payment,Status"];

 rows.forEach(row => {
     const cols = row.querySelectorAll("td");
     if (cols.length >= 6) {
         const name = cols[0].querySelector(".fw-bold").innerText.replace(/,/g, ""); 
         const total = cols[1].innerText.replace(/[$,]/g, "");
         const paid = cols[2].querySelector(".text-success").innerText.replace(/[$,]/g, "");
         const due = cols[3].innerText.replace(/[$,]/g, "");
         const lastPayment = cols[4].innerText.trim().replace(/,/g, "");
         const status = cols[5].querySelector(".badge").innerText.trim();
         
         csv.push(`${name},${total},${paid},${due},${lastPayment},${status}`);
     }
 });

 const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
 const downloadLink = document.createElement("a");
 downloadLink.download = `College_Fees_Report_${new Date().toISOString().split('T')[0]}.csv`;
 downloadLink.href = window.URL.createObjectURL(csvFile);
 document.body.appendChild(downloadLink);
 downloadLink.click();
 document.body.removeChild(downloadLink);
}

//3. Generate Official Invoice
function generateInvoice(id, name, total, paid, due) {
 const printWindow = window.open('', '_blank');
 printWindow.document.write(`
     <html>
         <head>
             <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
             <style> body { padding: 40px; } .receipt-border { border: 2px solid #eee; padding: 20px; border-radius: 10px; } </style>
         </head>
         <body onload="window.print()">
             <div class="receipt-border">
                 <div class="text-center mb-4"><h2 class="fw-bold">FEE RECEIPT</h2><p>University Finance Office</p></div>
                 <hr>
                 <p><strong>Student:</strong> ${name} (#${id})</p>
                 <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                 <table class="table table-bordered mt-4">
                     <thead><tr><th>Description</th><th class="text-end">Amount</th></tr></thead>
                     <tbody>
                         <tr><td>Tuition Fees</td><td class="text-end">$${total.toLocaleString()}</td></tr>
                         <tr class="table-success"><td><strong>Total Paid</strong></td><td class="text-end"><strong>$${paid.toLocaleString()}</strong></td></tr>
                         <tr class="table-danger"><td><strong>Balance Due</strong></td><td class="text-end"><strong>$${due.toLocaleString()}</strong></td></tr>
                     </tbody>
                 </table>
             </div>
         </body>
     </html>
 `);
 printWindow.document.close();
}

//4. Search Filter
function filterFeesTable() {
 const filter = document.getElementById("feesSearch").value.toLowerCase();
 const rows = document.querySelectorAll("#admin-fees-table tr");
 rows.forEach(row => {
     const text = row.cells[0].textContent.toLowerCase();
     row.style.display = text.includes(filter) ? "" : "none";
 });
}

//5. Payments Management (History & Billing)
async function managePayments(studId, name) {
 currentSelectedStudId = studId;
 document.getElementById('fee-student-name').innerText = name;
 
 try {
     const res = await fetch(`${BASE_URL}/college/fees/student/${studId}`, { headers: HEADERS });
     const data = await res.json();

     document.getElementById('update-total-amt').value = data.totalAmount;
     document.getElementById('update-exam-amt').value = data.examFees || 0;

     const historyBody = document.getElementById('payment-history-list');
     historyBody.innerHTML = data.paymentHistory.map(record => `
         <tr>
             <td>${new Date(record.paymentDate).toLocaleDateString()}</td>
             <td class="fw-bold text-success">$${record.amountPaid.toLocaleString()}</td>
             <td class="text-end">
                 <button class="btn btn-link text-danger p-0" onclick="deleteRecord(${record.id})">
                     <i class="bi bi-trash"></i>
                 </button>
             </td>
         </tr>`).join('');

     new bootstrap.Modal(document.getElementById('paymentModal')).show();
 } catch (err) { alert("Error loading history"); }
}

async function processPayment() {
 const amt = document.getElementById('new-payment-amt').value;
 if(!amt || amt <= 0) return alert("Enter valid amount");

 try {
     const res = await fetch(`${BASE_URL}/college/fees/${currentSelectedStudId}/pay?amount=${amt}`, {
         method: 'POST',
         headers: HEADERS
     });
     if(res.ok) {
         alert("Payment Recorded!");
         managePayments(currentSelectedStudId, document.getElementById('fee-student-name').innerText);
         fetchFeesLedger();
     }
 } catch (err) { alert("Payment Failed"); }
}

async function saveBilling() {
 const details = {
     totalAmount: parseFloat(document.getElementById('update-total-amt').value),
     examFees: parseFloat(document.getElementById('update-exam-amt').value)
 };

 try {
     const res = await fetch(`${BASE_URL}/college/fees/update-billing/${currentSelectedStudId}`, {
         method: 'PUT',
         headers: { ...HEADERS, 'Content-Type': 'application/json' },
         body: JSON.stringify(details)
     });
     if(res.ok) {
         alert("Billing Updated!");
         fetchFeesLedger();
     }
 } catch (err) { alert("Update failed"); }
}

//6. Toggle Pending vs All
function applyFeeFilter(type) {
 const rows = document.querySelectorAll('#admin-fees-table tr');
 let visibleCount = 0;

 rows.forEach(row => {
     const dueAmount = parseFloat(row.getAttribute('data-due'));
     if (type === 'due') {
         const isVisible = dueAmount > 0;
         row.style.display = isVisible ? "" : "none";
         if (isVisible) visibleCount++;
     } else {
         row.style.display = "";
         visibleCount++;
     }
 });
}


///Attendance swession

// Function to fetch all attendance for Admin
async function fetchAttendanceAll() {
    const tableBody = document.getElementById('attendance-table-body');
    const dateInput = document.getElementById('attendance-date-filter');
    
    // Default to today's date
    const selectedDate = dateInput.value || new Date().toISOString().split('T')[0];
    
    try {
        const response = await fetch(`${BASE_URL}/college/attendance/all?date=${selectedDate}`, { 
            headers: HEADERS 
        });

        if (!response.ok) throw new Error("Server response was not ok");
        
        const list = await response.json();
        
        tableBody.innerHTML = '';
        let counts = { PRESENT: 0, ABSENT: 0, LATE: 0 };

        if (!list || list.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No attendance records found for this date.</td></tr>';
            updateAttendanceStats(counts);
            return;
        }

        list.forEach(att => {
            // Safety check for nested Student object (ensure @JsonIgnore is removed in Java)
            const studentObj = att.student || {}; 
            const sName = studentObj.fullName || "Unknown Student";
            const sId = studentObj.studId || "N/A";

            // Update Counters
            const statusKey = att.status ? att.status.toUpperCase() : "";
            if (counts.hasOwnProperty(statusKey)) counts[statusKey]++;

            // Handle Address Fallback
            const displayAddress = att.address && att.address !== "null" ? att.address : "Location not recorded";

            // FIX: Corrected Maps URL format
            const googleMapsUrl = `https://www.google.com/maps?q=${att.latitude},${att.longitude}`;

            tableBody.innerHTML += `
                <tr class="attendance-row">
                    <td class="ps-4">
                        <div class="fw-bold text-dark s-name">${sName}</div>
                        <div class="text-muted small s-id">ID: #${sId}</div>
                    </td>
                    <td class="text-secondary">${att.time || '--:--'}</td>
                    <td>
                        <span class="badge ${getStatusBadge(att.status)} rounded-pill px-3">
                            ${att.status}
                        </span>
                    </td>
                    <td class="small text-muted">
                        <div class="text-truncate" style="max-width: 180px;" title="${displayAddress}">
                            <i class="bi bi-geo-alt me-1"></i> ${displayAddress}
                        </div>
                    </td>
                    <td class="text-center">
                        ${(att.latitude && att.latitude !== 0) ? `
                            <a href="${googleMapsUrl}" target="_blank" class="btn btn-sm btn-light text-primary border shadow-sm">
                                <i class="bi bi-pin-map-fill"></i> View
                            </a>` : '<span class="badge bg-light text-muted border fw-normal">No GPS</span>'}
                    </td>
                    <td class="text-center pe-4">
                        <button class="btn btn-sm btn-outline-danger border-0" onclick="deleteAttendance(${att.attendId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });

        updateAttendanceStats(counts);

    } catch (err) {
        console.error("Attendance Load Error:", err);
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger fw-bold">Connection Error: Could not reach attendance records.</td></tr>';
    }
}

// --- NEW: SEARCH FUNCTION ---
function filterAttendanceTable() {
    const filter = document.getElementById("attendanceSearch").value.toLowerCase();
    const rows = document.querySelectorAll(".attendance-row");

    rows.forEach(row => {
        const name = row.querySelector(".s-name").textContent.toLowerCase();
        const id = row.querySelector(".s-id").textContent.toLowerCase();
        row.style.display = (name.includes(filter) || id.includes(filter)) ? "" : "none";
    });
}

// --- NEW: DOWNLOAD EXCEL (CSV) ---
function downloadAttendanceExcel() {
    const rows = document.querySelectorAll(".attendance-row");
    let csv = ["Student Name,Student ID,Time,Status,Location"];

    rows.forEach(row => {
        const name = row.querySelector(".s-name").textContent.replace(/,/g, "");
        const id = row.querySelector(".s-id").textContent.replace("ID: #", "");
        const time = row.cells[1].textContent;
        const status = row.cells[2].textContent.trim();
        const loc = row.cells[3].textContent.trim().replace(/,/g, " ");
        csv.push(`${name},${id},${time},${status},${loc}`);
    });

    const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Attendance_Report_${new Date().toISOString().split('T')[0]}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
// Helper function to update stats UI
function updateAttendanceStats(counts) {
    document.getElementById('stat-present').innerText = counts.PRESENT;
    document.getElementById('stat-absent').innerText = counts.ABSENT;
    document.getElementById('stat-late').innerText = counts.LATE;
}

function getStatusBadge(status) {
    switch(status) {
        case 'PRESENT': return 'bg-success-subtle text-success';
        case 'LATE': return 'bg-warning-subtle text-warning';
        case 'ABSENT': return 'bg-danger-subtle text-danger';
        default: return 'bg-secondary-subtle';
    }
}

async function deleteAttendance(id) {
    if(!confirm("Delete this record?")) return;
    try {
        const res = await fetch(`${BASE_URL}/college/attendance/delete/${id}`, { method: 'DELETE', headers: HEADERS });
        if(res.ok) fetchAttendanceAll();
    } catch (err) { alert("Delete failed"); }
}

//--- 1. SEARCH FILTER LOGIC ---
function filterAttendanceTable() {
    const filter = document.getElementById("attendanceSearch").value.toLowerCase();
    const rows = document.querySelectorAll("#attendance-table-body tr");

    rows.forEach(row => {
        const studentInfo = row.cells[0].textContent.toLowerCase();
        // Check if row has data (ignore "No records" row)
        if (row.cells.length > 1) {
            row.style.display = studentInfo.includes(filter) ? "" : "none";
        }
    });
}

// --- 2. EXCEL EXPORT LOGIC ---
/* function downloadAttendanceExcel() {
    const tableBody = document.getElementById("attendance-table-body");
    const rows = tableBody.querySelectorAll("tr");
    const selectedDate = document.getElementById('attendance-date-filter').value || "Today";
    
    // Define CSV Headers
    let csv = ["Student Name,Student ID,Time,Status,Address"];

    rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        
        // Ensure it's a data row and not a "No records" message
        if (cols.length >= 5) {
            const name = cols[0].querySelector(".fw-bold").innerText.replace(/,/g, ""); 
            const id = cols[0].querySelector(".small").innerText.replace("ID: #", "");
            const time = cols[1].innerText.trim();
            const status = cols[2].innerText.trim();
            // Remove commas from address to prevent CSV format breakage
            const address = cols[3].innerText.trim().replace(/,/g, " "); 
            
            csv.push(`${name},${id},${time},${status},${address}`);
        }
    });

    if (csv.length <= 1) return alert("No records available to export!");

    // Create Download Link
    const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
    const downloadLink = document.createElement("a");
    const fileName = `Attendance_Report_${selectedDate}.csv`;
    
    downloadLink.download = fileName;
    downloadLink.href = window.URL.createObjectURL(csvFile);
    downloadLink.style.display = "none";
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
} */

async function generateMonthlyReport() {
    const reportBody = document.getElementById('monthly-report-body');
    reportBody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm text-primary"></div> Calculating...</td></tr>';
    
    try {
        // Fetch all records (In a real app, you'd filter by month on the backend)
        const response = await fetch(`${BASE_URL}/college/attendance/all`, { headers: HEADERS });
        const list = await response.json();
        
        // Group data by Student ID
        const report = {};
        list.forEach(att => {
            const sid = att.student?.studId;
            if (!sid) return;

            if (!report[sid]) {
                report[sid] = {
                    name: att.student.fullName,
                    total: 0,
                    present: 0
                };
            }
            report[sid].total++;
            if (att.status === 'PRESENT' || att.status === 'LATE') {
                report[sid].present++;
            }
        });

        // Render the report
        reportBody.innerHTML = '';
        Object.values(report).forEach(data => {
            const percentage = Math.round((data.present / data.total) * 100);
            const isLow = percentage < 75;

            reportBody.innerHTML += `
                <tr>
                    <td><div class="fw-bold">${data.name}</div></td>
                    <td>${data.total}</td>
                    <td>${data.present}</td>
                    <td>
                        <div class="d-flex align-items-center">
                            <span class="me-2 fw-bold ${isLow ? 'text-danger' : 'text-success'}">${percentage}%</span>
                            <div class="progress flex-grow-1" style="height: 5px;">
                                <div class="progress-bar ${isLow ? 'bg-danger' : 'bg-success'}" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${isLow ? 'bg-danger-subtle text-danger' : 'bg-success-subtle text-success'}">
                            ${isLow ? 'Shortage' : 'Good'}
                        </span>
                    </td>
                </tr>`;
        });

        new bootstrap.Modal(document.getElementById('attendanceReportModal')).show();

    } catch (err) {
        reportBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error generating report.</td></tr>';
    }
}

function downloadMonthlyExcel() {
    const tableBody = document.getElementById("monthly-report-body");
    const rows = tableBody.querySelectorAll("tr");
    
    // Check if there is data to export
    if (rows.length === 0 || rows[0].innerText.includes("Calculating")) {
        alert("Please wait for the report to load before downloading.");
        return;
    }

    // Define CSV Headers
    let csv = ["Student Name,Total Days,Present Days,Percentage,Status"];

    rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        
        if (cols.length >= 5) {
            const name = cols[0].innerText.trim().replace(/,/g, ""); 
            const total = cols[1].innerText.trim();
            const present = cols[2].innerText.trim();
            // Get percentage (remove the % symbol)
            const percentage = cols[3].querySelector(".fw-bold").innerText.replace("%", "");
            const status = cols[4].innerText.trim();
            
            csv.push(`${name},${total},${present},${percentage},${status}`);
        }
    });

    // Generate and trigger download
    const csvContent = "data:text/csv;charset=utf-8," + csv.join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    
    const date = new Date();
    const fileName = `Monthly_Attendance_Report_${date.toLocaleString('default', { month: 'long' })}_${date.getFullYear()}.csv`;
    
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", fileName);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

////Academic Records

// 1. Fill the dropdown with students
// --- LOAD STUDENTS FOR DROPDOWN ---
async function fetchStudentsForAcademic() {
    const select = document.getElementById('academic-student-select');
    if (!select) return;

    try {
        // Double check: Is your BASE_URL defined? Is it "http://localhost:8080"?
        const response = await fetch(`${BASE_URL}/college/students/all`, { 
            headers: HEADERS 
        });

        if (!response.ok) throw new Error("Failed to fetch students");

        const students = await response.json();
        
        // Clear existing options
        select.innerHTML = '<option value="">Select a Student...</option>';

        if (Array.isArray(students)) {
            students.forEach(s => {
                const option = document.createElement('option');
                option.value = s.studId; // Matches your Long studId in Java
                option.textContent = `${s.fullName} (ID: ${s.studId})`;
                select.appendChild(option);
            });
            console.log("Students loaded for Academic Session:", students.length);
        }
    } catch (err) {
        console.error("Fetch Error:", err);
        select.innerHTML = '<option value="">Error loading students</option>';
    }
}
async function loadStudentAcademicRecords() {
    const studId = document.getElementById('academic-student-select').value;
    const tableBody = document.getElementById('academic-table-body');
    
    if (!studId) {
        tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Select a student...</td></tr>';
        return;
    }

    try {
        // MATCHES JAVA: /college/academic/student/{studId}
        const response = await fetch(`${BASE_URL}/college/academic/student/${studId}`, { 
            headers: HEADERS 
        });
        const records = await response.json();
        
        tableBody.innerHTML = '';
        if (records.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No academic records found for this student.</td></tr>';
            return;
        }

        records.forEach(r => {
            tableBody.innerHTML += `
                <tr>
                    <td class="ps-4 fw-bold">${r.academicYear}</td>
                    <td>Year ${r.currentYear}</td>
                    <td>${r.courseName}</td>
                    <td><span class="badge ${r.status === 'Pass' ? 'bg-success' : 'bg-danger'} rounded-pill">${r.status}</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-light border" onclick='editAcademicRecord(${JSON.stringify(r)})'>
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-light border text-danger" onclick="deleteAcademicRecord(${r.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
        });
    } catch (err) {
        console.error("Fetch Error:", err);
    }
}
document.getElementById('academicForm').onsubmit = async (e) => {
    e.preventDefault();
    
    // 1. Get the Student ID from the dropdown
    const studId = document.getElementById('academic-student-select').value;
    const recordId = document.getElementById('recordId').value;
    
    if (!studId) {
        alert("Please select a student first!");
        return;
    }

    const data = {
        courseName: document.getElementById('ac-course').value,
        academicYear: document.getElementById('ac-acadYear').value,
        currentYear: parseInt(document.getElementById('ac-currYear').value),
        status: document.getElementById('ac-status').value
    };

    // 2. Construct the correct URL
    // If recordId exists, we UPDATE (PUT). If not, we ADD (POST) to that student.
    const url = recordId 
        ? `${BASE_URL}/college/academic/update/${recordId}` 
        : `${BASE_URL}/college/academic/add/${studId}`;
    
    const method = recordId ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            headers: HEADERS,
            body: JSON.stringify(data)
        });

        if (res.ok) {
            // Success! Hide modal and refresh the table
            const modalEl = document.getElementById('academicModal');
            bootstrap.Modal.getInstance(modalEl).hide();
            loadStudentAcademicRecords(); // Refresh the list for this student
            alert("Record saved successfully!");
        } else {
            const errData = await res.json();
            alert("Error: " + (errData.message || "Could not save record"));
        }
    } catch (err) {
        console.error("Submit Error:", err);
        alert("Connection failed. Is the server running?");
    }
};

// --- OPEN MODAL FOR ADDING ---
function openAddAcademicModal() {
    document.getElementById('academicForm').reset();
    document.getElementById('recordId').value = ''; // Clear ID for "Add" mode
    document.getElementById('academicModalTitle').innerText = "Add Academic Record";
    new bootstrap.Modal(document.getElementById('academicModal')).show();
}

// --- EDIT RECORD ---
function editAcademicRecord(record) {
    document.getElementById('recordId').value = record.id;
    document.getElementById('ac-acadYear').value = record.academicYear;
    document.getElementById('ac-currYear').value = record.currentYear;
    document.getElementById('ac-status').value = record.status;
    document.getElementById('ac-course').value = record.courseName;
    
    document.getElementById('academicModalTitle').innerText = "Edit Academic Record";
    new bootstrap.Modal(document.getElementById('academicModal')).show();
}

// --- DELETE RECORD ---
async function deleteAcademicRecord(id) {
    if (!confirm("Are you sure you want to delete this year's record?")) return;
    
    try {
        const res = await fetch(`${BASE_URL}/college/academic/delete/${id}`, { 
            method: 'DELETE', 
            headers: HEADERS 
        });
        if (res.ok) {
            loadStudentAcademicRecords(); // Refresh the table
        }
    } catch (err) {
        alert("Delete failed");
    }
}

        function logout() {
            localStorage.clear();
            window.location.href = "admin-auth.html";
        }
    </script>
</body>
</html>