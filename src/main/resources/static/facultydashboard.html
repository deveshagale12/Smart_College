<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard | COLLEGE.io</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        .nav-item.active { background-color: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        .action-btn-styled {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0.75rem; border-radius: 1.25rem; transition: all 0.2s ease;
        }

        .content-view { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="pb-24 md:pb-0">

    <div class="min-h-screen flex flex-col md:flex-row">
        <aside class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-md border-t border-slate-200 z-[100] md:relative md:w-72 md:border-t-0 md:border-r md:h-screen md:bg-white">
            <div class="hidden md:block p-8 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                        <i class="fas fa-university"></i>
                    </div>
                    <span class="text-xl font-black text-slate-800 tracking-tight">COLLEGE.io</span>
                </div>
            </div>
            
            <nav class="flex flex-row md:flex-col justify-around md:justify-start p-3 md:p-6 gap-2 h-[100px] md:h-full">
    <button onclick="showTab('students', this)" class="nav-item active flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1 md:flex-none">
        <i class="fas fa-columns"></i>
        <span class="text-[10px] md:text-sm font-bold">Overview</span>
    </button>
    <button onclick="showTab('attendance', this)" class="nav-item flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1 md:flex-none">
        <i class="fas fa-calendar-check"></i>
        <span class="text-[10px] md:text-sm font-bold">Attendance</span>
    </button>
    <button onclick="showTab('assign', this)" class="nav-item flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1 md:flex-none">
        <i class="fas fa-user-plus"></i>
        <span class="text-[10px] md:text-sm font-bold">Assign</span>
    </button>
   
    <button onclick="showTab('profile', this)" class="nav-item flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1 md:flex-none">
        <i class="fas fa-fingerprint"></i>
        <span class="text-[10px] md:text-sm font-bold">Profile</span>
    </button>
    <button onclick="showTab('assignments', this)" class="nav-item flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1 md:flex-none">
    <i class="fas fa-tasks"></i>
    <span class="text-[10px] md:text-sm font-bold">Assignments</span>
</button>
    <button onclick="handleLogout()" class="flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 text-red-500 rounded-2xl flex-1 md:flex-none md:mt-auto hover:bg-red-50 transition-all">
        <i class="fas fa-power-off"></i>
        <span class="text-[10px] md:text-sm font-bold">Logout</span>
    </button>
</nav>
        </aside>

        <main class="flex-1 p-4 md:p-12 overflow-y-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                <div>
                    <h2 id="viewTitle" class="text-4xl font-black text-slate-900 tracking-tight">Dashboard</h2>
                    <p id="facultySub" class="text-slate-500 font-medium mt-1">Faculty Portal Access</p>
                </div>
                <div class="flex items-center gap-4 bg-white p-2 pr-6 rounded-2xl shadow-sm border border-slate-100">
                    <div id="facultyInitial" class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center font-bold text-xl">F</div>
                    <div>
                        <p id="facultyNameDisplay" class="font-bold text-slate-800 text-sm">Faculty Member</p>
                        <p class="text-[10px] text-green-500 font-bold uppercase tracking-widest">‚óè Online Now</p>
                    </div>
                   <button id="masterBtn" onclick="downloadMasterReport()" class="flex items-center gap-2 bg-slate-900 text-white px-6 py-3 rounded-2xl font-black text-xs tracking-widest hover:scale-105 transition-all">
    <i id="masterIcon" class="fas fa-database text-blue-400"></i> 
    <span id="masterText">MASTER EXCEL BACKUP</span>
</button>
                </div>
            </header>

            <div id="stats-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="lg:col-span-2 glass-card p-6 rounded-[2rem] shadow-xl shadow-blue-900/5 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-slate-800">Today's Attendance</h3>
                        <div class="flex gap-6">
                            <div class="space-y-1">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Present</p>
                                <p id="label-present" class="text-2xl font-black text-green-500">0</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Absent</p>
                                <p id="label-absent" class="text-2xl font-black text-red-500">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="relative w-32 h-32 flex items-center justify-center">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="64" cy="64" r="50" stroke="#f1f5f9" stroke-width="12" fill="transparent" />
                            <circle id="progress-circle" cx="64" cy="64" r="50" stroke="#2563eb" stroke-width="12" fill="transparent" 
                                    stroke-dasharray="314.15" stroke-dashoffset="314.15" stroke-linecap="round" class="transition-all duration-1000" />
                        </svg>
                        <span id="perc-text" class="absolute text-xl font-black text-slate-800">0%</span>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-8 rounded-[2rem] text-white flex flex-col justify-between shadow-2xl">
                    <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest">Smart Scheduler</p>
                    <p class="text-sm font-medium mt-2 leading-relaxed">The system automatically logs absentees daily at <span class="text-blue-400 font-bold">4:01 PM</span>.</p>
                    <button onclick="viewTodayAbsentees()" class="mt-6 w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs backdrop-blur-md transition-all border border-white/10">
                        View Absentees List
                    </button>
                </div>
            </div>

            <div id="search-section" class="mb-8">
                <div class="relative max-w-xl">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="studentSearch" onkeyup="filterStudents()" 
                           placeholder="Search by name, ID or course..." 
                           class="w-full pl-14 pr-6 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-4 focus:ring-blue-100 outline-none transition-all font-medium">
                </div>
            </div>

            <div id="view-students" class="content-view grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

          <div id="view-assign" class="content-view hidden">
    <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
            <div>
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Unassigned Students</h3>
                <p class="text-xs text-slate-500 font-bold">Select students to assign to your department</p>
            </div>
            <button onclick="processAssignment()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-200 transition-all active:scale-95">
                Confirm Assignment
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest font-black">
                    <tr>
                        <th class="px-8 py-5">Select</th>
                        <th class="px-8 py-5">Full Name</th>
                        <th class="px-8 py-5">Course / Department</th>
                    </tr>
                </thead>
                <tbody id="unassignedList" class="divide-y divide-slate-100 font-medium">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div id="view-assignments" class="content-view hidden">
    <div class="glass-card rounded-[2.5rem] p-10 shadow-2xl">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
            <div class="flex items-center gap-5">
                <div class="w-14 h-14 bg-emerald-600 rounded-2xl flex items-center justify-center text-white text-xl shadow-lg shadow-emerald-100">
                    <i class="fas fa-file-export"></i>
                </div>
                <div>
                    <h3 class="font-black text-2xl text-slate-800 tracking-tight">Assignment Grading</h3>
                    <p class="text-slate-500 text-xs font-bold uppercase tracking-widest">NeonDB Live Records</p>
                </div>
            </div>
            <button onclick="exportAssignmentsToExcel()" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-black text-xs hover:bg-emerald-600 transition-all flex items-center gap-3 shadow-xl">
                <i class="fas fa-file-csv text-lg"></i> EXPORT TO EXCEL
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-separate border-spacing-y-3">
                <thead class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] px-4">
                    <tr>
                        <th class="px-6 py-2">Student Name</th>
                        <th class="px-6 py-2">Task Title</th>
                        <th class="px-6 py-2">Submitted On</th>
                        <th class="px-6 py-2">Status / Marks</th>
                        <th class="px-6 py-2 text-right">Review</th>
                    </tr>
                </thead>
                <tbody id="facultyAssignmentTable">
                    </tbody>
            </table>
        </div>
    </div>
</div>
<div id="previewModal" class="hidden fixed inset-0 bg-slate-900/90 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
<button onclick="printPreview()" class="mr-2 h-10 px-4 bg-slate-900 text-white rounded-full text-[10px] font-black hover:bg-black transition flex items-center gap-2">
    <i class="fas fa-print"></i> PRINT
</button>
    <div class="bg-white w-full max-w-5xl h-[90vh] rounded-[3rem] overflow-hidden flex flex-col shadow-2xl">
        <div class="p-6 border-b flex justify-between items-center bg-slate-50">
            <div>
                <h2 id="previewTitle" class="font-black text-slate-800 uppercase tracking-tight">Document Preview</h2>
                <p id="previewSubtitle" class="text-[10px] font-bold text-slate-400 uppercase italic"></p>
            </div>
            <button onclick="closePreview()" class="h-10 w-10 bg-white border border-slate-200 rounded-full flex items-center justify-center hover:bg-rose-50 hover:text-rose-500 transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="previewContainer" class="flex-1 overflow-auto bg-slate-200 p-4 flex justify-center">
            </div>
    </div>
</div>
<div id="gradeModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-md z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-2xl shadow-2xl scale-in-center">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h2 class="text-2xl font-black text-slate-800 tracking-tight">Review Submission</h2>
                <p class="text-blue-600 text-[10px] font-black uppercase tracking-widest mt-1">NeonDB Live Evaluation</p>
            </div>
            <button onclick="closeGradeModal()" class="text-slate-300 hover:text-rose-500 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <div class="space-y-6">
            <div class="bg-slate-50 p-6 rounded-3xl border border-slate-100">
                <h4 id="revTitle" class="font-black text-blue-600 text-sm mb-2 uppercase italic tracking-tight"></h4>
                <p id="revContent" class="text-slate-600 text-xs leading-relaxed max-h-40 overflow-y-auto custom-scrollbar italic"></p>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-tighter">Award Marks (0-100)</label>
                    <input type="number" id="gradeMarks" min="0" max="100" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-sm outline-none focus:ring-4 focus:ring-blue-50">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-tighter">Set Status</label>
                    <select id="gradeStatus" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-xs outline-none cursor-pointer">
                        <option value="Submitted">Submitted</option>
                        <option value="Graded">Mark as Graded</option>
                    </select>
                </div>
            </div>

            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2 tracking-tighter">Faculty Feedback</label>
                <textarea id="gradeFeedback" rows="3" class="w-full p-5 rounded-2xl bg-slate-50 border border-slate-200 outline-none focus:ring-4 focus:ring-blue-50 text-sm" placeholder="Add comments for the student..."></textarea>
            </div>

            <div class="flex gap-4">
                <button id="downloadBtn" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-black text-xs hover:bg-black transition shadow-xl">
                    <i class="fas fa-download mr-2"></i> DOWNLOAD FILE
                </button>
                <button onclick="submitGrade()" class="flex-[1.5] bg-blue-600 text-white py-5 rounded-2xl font-black shadow-xl shadow-blue-100 hover:bg-blue-700 transition">
                    SAVE & UPDATE NEON
                </button>
            </div>
        </div>
    </div>
</div>
            <div id="view-profile" class="content-view hidden">
                <div class="max-w-3xl glass-card rounded-[2.5rem] p-10 shadow-2xl">
                    <div class="mb-10 flex items-center gap-6">
                        <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center text-white text-3xl shadow-xl shadow-blue-200">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <h3 class="font-black text-3xl text-slate-800 tracking-tight">Faculty Settings</h3>
                            <p class="text-slate-500 font-medium">Management & Security Preference</p>
                        </div>
                    </div>
                    
                    <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Full Name</label>
                            <input type="text" id="profName" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Faculty ID (Static)</label>
                            <input type="text" id="profId" class="w-full p-4 rounded-2xl bg-slate-100 border border-slate-200 text-slate-400" readonly>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Specialization Subject</label>
                            <input type="text" id="profSub" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Annual Salary</label>
                            <input type="number" id="profSal" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none">
                        </div>
                        <div class="space-y-2 col-span-full">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Update Password</label>
                            <input type="password" id="profPass" placeholder="Leave blank to remain unchanged" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none">
                        </div>
                        <button type="button" onclick="updateProfile()" class="col-span-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg hover:bg-black hover:shadow-2xl transition-all mt-4">
                            Update Faculty Profile
                        </button>
                    </form>
                </div>
            </div>
            <div id="view-attendance" class="content-view hidden space-y-6">
    <div class="flex flex-col lg:flex-row gap-4 items-end bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
        <button onclick="openAttendanceSession()" class="w-full lg:w-auto bg-blue-600 text-white px-8 py-4 rounded-2xl font-black text-xs tracking-widest shadow-xl shadow-blue-100 hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
            <i class="fas fa-play-circle text-lg"></i> START NEW SESSION
        </button>
        
        <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3 w-full">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="attSearch" onkeyup="applyAttendanceFilters()" placeholder="Filter by Student Name..." 
                       class="w-full pl-12 pr-4 py-3 bg-slate-50 rounded-xl border-none text-sm font-bold outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="relative">
                <i class="fas fa-calendar-alt absolute left-4 top-1/2 -translate-y-1/2 text-blue-500"></i>
                <input type="date" id="attDate" onchange="applyAttendanceFilters()" 
                       class="w-full pl-12 pr-4 py-3 bg-slate-50 rounded-xl border-none text-sm font-bold outline-none">
            </div>
        </div>

        <button onclick="downloadAttendanceExcel()" class="bg-emerald-600 text-white px-6 py-4 rounded-2xl font-black text-xs flex items-center gap-2 shadow-lg shadow-emerald-100">
            <i class="fas fa-file-excel"></i> EXPORT
        </button>
    </div>

    <div class="bg-white rounded-[2.5rem] shadow-sm border border-slate-200 overflow-hidden">
        <table class="w-full text-left">
            <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest font-black">
                <tr>
                    <th class="px-8 py-5">Date/Time</th>
                    <th class="px-8 py-5">Student</th>
                    <th class="px-8 py-5">Status</th>
                    <th class="px-8 py-5 text-right">Action</th>
                </tr>
            </thead>
            <tbody id="attendanceHistoryBody" class="divide-y divide-slate-100 font-medium"></tbody>
        </table>
    </div>
</div>


        </main>
    </div>

    <div id="actionModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeModal()"></div>
        <div class="relative bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden transform scale-100 transition-all">
            <div id="modalHeader" class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <h3 id="modalTitle" class="text-2xl font-black text-slate-800 tracking-tight">Action</h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 hover:text-red-500 transition-all">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="modalBody" class="p-8 max-h-[60vh] overflow-y-auto"></div>
            
            <div class="p-6 bg-slate-50/80 border-t flex justify-end gap-3 px-8">
                <button onclick="closeModal()" class="px-6 py-3 text-slate-600 font-bold hover:bg-slate-200 rounded-xl transition-all">Discard</button>
                <button id="modalSubmit" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">Apply Changes</button>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.min.js"></script>
    <script>
    const API = "https://smart-college.onrender.com";
    let faculty = JSON.parse(localStorage.getItem('facultySession'));
    let allAssignedStudents = [];
    let attMasterRecords = [];
    let currentView = 'students'; // Track current tab

    window.onload = () => {
        if (!faculty) {
            alert("Session expired. Please login.");
            window.location.href = "faculty-auth.html";
            return;
        }
        refreshHeader();
        loadAssigned();
    };

    function refreshHeader() {
        document.getElementById('facultySub').innerText = `${faculty.subject} | ID: ${faculty.facultyId}`;
        document.getElementById('facultyNameDisplay').innerText = faculty.name;
        document.getElementById('facultyInitial').innerText = faculty.name[0];
    }


    // --- CORE DATA FETCHING ---
    async function loadAssigned() {
        try {
            const res = await fetch(`${API}/api/faculty/${faculty.id}/students`);
            allAssignedStudents = await res.json();
            renderStudentCards(allAssignedStudents);
            updateAttendanceWidget();
            if (currentView === 'notes') {
                populateNoteDropdown(); 
            }
        } catch (e) { console.error("Error loading students", e); }
    }
    

    function renderStudentCards(data) {
        const container = document.getElementById('view-students');
        if (data.length === 0) {
            container.innerHTML = `<div class="col-span-full py-20 text-center opacity-40 font-bold">No students found.</div>`;
            return;
        }
        container.innerHTML = data.map(s => `
            <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                <div class="p-6 bg-slate-50/50 border-b flex items-center gap-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-200">
                        ${s.fullName[0]}
                    </div>
                    <div>
                        <h4 class="font-black text-slate-800 leading-tight">${s.fullName}</h4>
                        <p class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mt-1">${s.course} ‚Ä¢ Year ${s.year}</p>
                    </div>
                </div>

                <div class="p-4 grid grid-cols-3 gap-2">
                    <button onclick="manageAttendance(${s.studId})" class="action-btn-styled text-blue-600 hover:bg-blue-50">
                        <i class="fas fa-calendar-check text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Attend</span>
                    </button>
                    <button onclick="viewAcademicRecords(${s.studId})" class="action-btn-styled text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-file-invoice text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Records</span>
                    </button>
                    <button onclick="checkFees(${s.studId})" class="action-btn-styled text-emerald-600 hover:bg-emerald-50">
                        <i class="fas fa-wallet text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Fees</span>
                    </button>
                    <button onclick="addMarks(${s.studId})" class="action-btn-styled text-amber-600 hover:bg-amber-50">
                        <i class="fas fa-medal text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Marks</span>
                    </button>
                    <button onclick="viewParents(${s.studId})" class="action-btn-styled text-purple-600 hover:bg-purple-50">
                        <i class="fas fa-user-friends text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Parents</span>
                    </button>
                    
                    <button onclick="studentDetails(${s.studId})" class="action-btn-styled text-slate-500 hover:bg-slate-100">
                        <i class="fas fa-info-circle text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Info</span>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // --- LATEST FUNCTION: FILTERING & SEARCH ---
    function filterStudents() {
        const query = document.getElementById('studentSearch').value.toLowerCase();
        const filtered = allAssignedStudents.filter(s => 
            s.fullName.toLowerCase().includes(query) || 
            s.studId.toString().includes(query) ||
            s.course.toLowerCase().includes(query)
        );
        renderStudentCards(filtered);
    }
    async function loadUnassignedStudents() {
        const container = document.getElementById('unassignedList');
        if (!container) return console.error("Could not find table body 'unassignedList'");

        container.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-400 animate-pulse">Scanning database...</td></tr>`;

        try {
            console.log("Fetching students and fees...");
            const [studRes, feeRes] = await Promise.all([
                fetch(`${API}/college/students/all`),
                fetch(`${API}/college/fees/all`)
            ]);

            if (!studRes.ok || !feeRes.ok) throw new Error("API Response Error");

            const students = await studRes.json();
            const fees = await feeRes.json();

            // Check if student has a record in the fees table
            const assignedIds = fees.map(f => f.student ? f.student.studId : null);
          //  const unassigned = students.filter(s => !assignedIds.includes(s.studId));
            const unassigned = students.filter(s => s.faculty === null);

            console.log("Unassigned students found:", unassigned.length);

            if (unassigned.length === 0) {
                container.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-400 font-bold italic">üéâ All students are assigned!</td></tr>`;
                return;
            }

            container.innerHTML = unassigned.map(s => `
                <tr class="hover:bg-slate-50 transition-all border-b border-slate-100">
                    <td class="px-8 py-4">
                        <input type="checkbox" name="studentSelect" value="${s.studId}" 
                               class="stu-check w-5 h-5 rounded-lg border-slate-300 text-blue-600 focus:ring-blue-500">
                    </td>
                    <td class="px-8 py-4">
                        <p class="font-black text-slate-800">${s.fullName || s.name || 'Unnamed Student'}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">ID: ${s.studId}</p>
                    </td>
                    <td class="px-8 py-4">
                        <span class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-[10px] font-black uppercase tracking-wider">
                            ${s.course || s.department || 'N/A'}
                        </span>
                    </td>
                </tr>
            `).join('');

        } catch (err) {
            console.error("Fetch Error:", err);
            container.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-red-500 font-bold">Failed to load. Is the Backend running?</td></tr>`;
        }
    }

 async function loadUnassignedStudents() {
        const container = document.getElementById('unassignedList');
        if (!container) return console.error("Could not find table body 'unassignedList'");

        container.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-400 animate-pulse">Scanning database...</td></tr>`;

        try {
            console.log("Fetching students and fees...");
            const [studRes, feeRes] = await Promise.all([
                fetch(`${API}/college/students/all`),
                fetch(`${API}/college/fees/all`)
            ]);

            if (!studRes.ok || !feeRes.ok) throw new Error("API Response Error");

            const students = await studRes.json();
            const fees = await feeRes.json();

            // Check if student has a record in the fees table
            const assignedIds = fees.map(f => f.student ? f.student.studId : null);
           // const unassigned = students.filter(s => !assignedIds.includes(s.studId));
           const unassigned = students.filter(s => s.faculty === null);

            console.log("Unassigned students found:", unassigned.length);

            if (unassigned.length === 0) {
                container.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-slate-400 font-bold italic">üéâ All students are assigned!</td></tr>`;
                return;
            }

            container.innerHTML = unassigned.map(s => `
                <tr class="hover:bg-slate-50 transition-all border-b border-slate-100">
                    <td class="px-8 py-4">
                        <input type="checkbox" name="studentSelect" value="${s.studId}" 
                               class="stu-check w-5 h-5 rounded-lg border-slate-300 text-blue-600 focus:ring-blue-500">
                    </td>
                    <td class="px-8 py-4">
                        <p class="font-black text-slate-800">${s.fullName || s.name || 'Unnamed Student'}</p>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">ID: ${s.studId}</p>
                    </td>
                    <td class="px-8 py-4">
                        <span class="px-3 py-1 bg-blue-50 text-blue-600 rounded-full text-[10px] font-black uppercase tracking-wider">
                            ${s.course || s.department || 'N/A'}
                        </span>
                    </td>
                </tr>
            `).join('');

        } catch (err) {
            console.error("Fetch Error:", err);
            container.innerHTML = `<tr><td colspan="3" class="p-10 text-center text-red-500 font-bold">Failed to load. Is the Backend running?</td></tr>`;
        }
    }
    // --- LATEST FUNCTION: ATTENDANCE WIDGET ---
    async function updateAttendanceWidget() {
        const today = new Date().toISOString().split('T')[0];
        try {
            const res = await fetch(`${API}/college/attendance/all?date=${today}`);
            const records = await res.json();
            
            const facultyStudentIds = allAssignedStudents.map(s => s.studId);
            const myRecords = records.filter(r => facultyStudentIds.includes(r.student.studId));
            
            const present = myRecords.filter(r => r.status === 'PRESENT' || r.status === 'LATE').length;
            const total = allAssignedStudents.length;
            const absent = total - present;

            document.getElementById('label-present').innerText = present;
            document.getElementById('label-absent').innerText = absent;

            const percentage = total > 0 ? (present / total) * 100 : 0;
            const circle = document.getElementById('progress-circle');
            const circumference = 314.15; // 2 * PI * 50
            circle.style.strokeDashoffset = circumference - (percentage / 100) * circumference;
            document.getElementById('perc-text').innerText = `${Math.round(percentage)}%`;
        } catch(e) {}
    }

    // --- MODAL & CRUD LOGIC ---
   function openModal(title, content, showSubmit = true, submitCallback = null) {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('actionModal').classList.remove('hidden');
    
    const submitBtn = document.getElementById('modalSubmit');
    
    if (showSubmit) {
        submitBtn.style.display = 'block';
        // We clear old listeners and add the new one
        submitBtn.onclick = async () => {
            if (submitCallback) await submitCallback();
        };
    } else {
        submitBtn.style.display = 'none';
    }
}

    function closeModal() { document.getElementById('actionModal').classList.add('hidden'); }

    // --- ATTENDANCE ---
    async function manageAttendance(studId) {
        const res = await fetch(`${API}/college/attendance/history/${studId}`);
        const history = await res.json();
        let content = `
            <div class="space-y-4">
                <button onclick="submitAttendance(${studId}, 'PRESENT')" class="w-full p-4 bg-green-600 text-white rounded-2xl font-black shadow-lg shadow-green-100 transition-all active:scale-95">Mark Present (GPS Check)</button>
                <div class="border-t pt-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3">Attendance History</p>
                    <div class="space-y-2">
                        ${history.slice(0, 5).map(h => `
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                <span class="text-sm font-bold text-slate-600">${h.date}</span>
                                <select onchange="updateAttendanceStatus(${h.attendId}, this.value, ${studId})" class="text-xs font-black p-1 rounded-lg ${h.status === 'PRESENT' ? 'text-green-600' : 'text-red-600'}">
                                    <option value="PRESENT" ${h.status === 'PRESENT' ? 'selected' : ''}>PRESENT</option>
                                    <option value="ABSENT" ${h.status === 'ABSENT' ? 'selected' : ''}>ABSENT</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        openModal("Attendance Center", content, false);
    }

    async function submitAttendance(studId, status) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const payload = { latitude: pos.coords.latitude, longitude: pos.coords.longitude, status: status };
            const res = await fetch(`${API}/college/attendance/mark/${studId}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            });
            if(res.ok) { alert("Success!"); closeModal(); updateAttendanceWidget(); }
            else alert(await res.text());
        }, () => alert("Enable GPS to mark attendance."));
    }

    async function updateAttendanceStatus(attendId, newStatus, studId) {
        await fetch(`${API}/college/attendance/update/${attendId}?status=${newStatus}`, { method: 'PUT' });
        manageAttendance(studId);
        updateAttendanceWidget();
    }

    // --- ACADEMIC (Full CRUD) ---
   // --- VIEW RECORDS ---
async function viewAcademicRecords(studId) {
    try {
        const res = await fetch(`${API}/college/academic/student/${studId}`);
        
        // If the server still says 401, it means Spring Security is active
        if (res.status === 401) {
            return alert("Access Denied (401). Please check your Spring Security configuration.");
        }

        const records = await res.json();
        
        let content = `
            <div class="space-y-4">
                <button onclick="academicFormUI(${studId})" class="w-full p-3 bg-indigo-600 text-white rounded-2xl font-bold">+ Add New Academic Year</button>
                <div class="space-y-2">
                    ${records.map(r => `
                        <div class="p-4 bg-white rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-black text-slate-800">${r.courseName}</p>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">${r.academicYear} ‚Ä¢ Year ${r.currentYear} ‚Ä¢ ${r.status}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick='academicFormUI(${studId}, ${JSON.stringify(r)})' class="w-8 h-8 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteAcademic(${r.id}, ${studId})" class="w-8 h-8 bg-red-50 text-red-600 rounded-lg"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `).join('') || '<p class="text-center text-slate-400 py-6">No history found.</p>'}
                </div>
            </div>`;
        openModal("Academic Management", content, false);
    } catch (err) {
        console.error(err);
    }
}
    
   async function deleteAcademic(recordId, studId) {
	    if(!confirm("Are you sure you want to delete this academic record?")) return;
	    const res = await fetch(`${API}/college/academic/delete/${recordId}`, { method: 'DELETE' });
	    if(res.ok) {
	        alert("Record Deleted");
	        viewAcademicRecords(studId); // Refresh the list
	    }
	}
// --- FORM FOR ADD/EDIT ---
  function academicFormUI(studId, existingData = null) {
    const isEdit = !!existingData;
    let content = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase">Academic Year</label>
                    <input type="text" id="acaYear" placeholder="2025-26" value="${isEdit ? existingData.academicYear : ''}" class="w-full p-3 bg-slate-50 rounded-xl border-none outline-none">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] font-black text-slate-400 uppercase">Current Year</label>
                    <input type="number" id="acaCur" placeholder="1, 2, 3..." value="${isEdit ? existingData.currentYear : ''}" class="w-full p-3 bg-slate-50 rounded-xl border-none outline-none">
                </div>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase">Course Name</label>
                <input type="text" id="acaCourse" value="${isEdit ? existingData.courseName : ''}" class="w-full p-3 bg-slate-50 rounded-xl border-none outline-none">
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase">Status</label>
                <select id="acaStatus" class="w-full p-3 bg-slate-50 rounded-xl border-none outline-none font-bold">
                    <option value="ACTIVE" ${isEdit && existingData.status === 'ACTIVE' ? 'selected' : ''}>ACTIVE</option>
                    <option value="COMPLETED" ${isEdit && existingData.status === 'COMPLETED' ? 'selected' : ''}>COMPLETED</option>
                </select>
            </div>
        </div>`;

    openModal(isEdit ? "Edit Record" : "Add Academic Record", content, true, async () => {
        const payload = {
            academicYear: document.getElementById('acaYear').value,
            currentYear: parseInt(document.getElementById('acaCur').value),
            courseName: document.getElementById('acaCourse').value,
            status: document.getElementById('acaStatus').value,
            student: { studId: studId }
        };

        const url = isEdit ? `${API}/college/academic/update/${existingData.id}` : `${API}/college/academic/add/${studId}`;
        const method = isEdit ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            closeModal();
            viewAcademicRecords(studId);
        }
    });
}
// --- SUBMIT (POST or PUT) ---
async function submitAcademic(studId, recordId = null) {
    // 1. Capture the form data
    const payload = {
        courseName: document.getElementById('ac-course').value,
        academicYear: document.getElementById('ac-year').value,
        currentYear: parseInt(document.getElementById('ac-current').value),
        status: document.getElementById('ac-status').value
    };

    // 2. Determine URL and Method
    const url = recordId ? `${API}/college/academic/update/${recordId}` : `${API}/college/academic/add/${studId}`;
    const method = recordId ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            // We use standard headers instead of the missing getHeaders() function
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert(recordId ? "Record Updated!" : "Record Added!");
            closeModal(); // Close the modal window
            viewAcademicRecords(studId); // Refresh the list automatically
        } else {
            const errorText = await res.text();
            alert("Server Error: " + errorText);
        }
    } catch (err) {
        console.error("Connection failed:", err);
        alert("Could not connect to the server.");
    }
}
async function deleteAcademic(recordId, studId) {
    if (!confirm("Are you sure you want to delete this academic record?")) return;

    try {
        const res = await fetch(`${API}/college/academic/delete/${recordId}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            alert("Record deleted successfully.");
            viewAcademicRecords(studId); // Refresh the list
        } else {
            alert("Delete failed. The record might already be gone.");
        }
    } catch (err) {
        console.error("Delete error:", err);
    }
}
    // --- MARKS ---
    async function addMarks(studId) {
        const res = await fetch(`${API}/college/marks/student/${studId}`);
        const marksList = await res.json();
        let content = `
            <div class="space-y-3">
                <button onclick="marksFormUI(${studId})" class="w-full mb-4 p-3 bg-amber-500 text-white rounded-2xl font-bold">+ Entry Marks</button>
                <div class="space-y-2">
                    ${marksList.map(m => `
                        <div class="p-4 bg-slate-50 rounded-2xl border flex justify-between items-center">
                            <div><p class="font-black text-slate-800">${m.subject}</p><p class="text-[10px] text-slate-500 font-bold uppercase">${m.testType}: ${m.obtainedMarks}/${m.outOf}</p></div>
                            <div class="flex gap-2">
                                <button onclick="marksFormUI(${studId}, ${JSON.stringify(m).replace(/"/g, '&quot;')})" class="text-blue-500"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteMark(${m.marksId}, ${studId})" class="text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`).join('')}
                </div>
            </div>`;
        openModal("Examination Center", content, false);
    }

    function marksFormUI(studId, data = null) {
        const isEdit = !!data;
        let content = `
            <div class="space-y-4">
                <input type="text" id="m-sub" class="w-full p-4 bg-slate-100 rounded-xl" placeholder="Subject" value="${isEdit ? data.subject : ''}">
                <input type="text" id="m-type" class="w-full p-4 bg-slate-100 rounded-xl" placeholder="Type" value="${isEdit ? data.testType : ''}">
                <div class="flex gap-2">
                    <input type="number" id="m-got" class="flex-1 p-4 bg-slate-100 rounded-xl" placeholder="Marks" value="${isEdit ? data.obtainedMarks : ''}">
                    <input type="number" id="m-out" class="flex-1 p-4 bg-slate-100 rounded-xl" placeholder="Total" value="${isEdit ? data.outOf : ''}">
                </div>
            </div>`;
        openModal(isEdit ? "Update Marks" : "Add Marks", content, true, () => submitMarks(studId, data?.marksId));
    }

    async function submitMarks(studId, marksId = null) {
        const payload = { subject: document.getElementById('m-sub').value, testType: document.getElementById('m-type').value, obtainedMarks: parseFloat(document.getElementById('m-got').value), outOf: parseFloat(document.getElementById('m-out').value) };
        const url = marksId ? `${API}/college/marks/${marksId}` : `${API}/college/marks/${studId}`;
        const res = await fetch(url, { method: marksId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        if(res.ok) addMarks(studId);
    }

    async function deleteMark(id, studId) { await fetch(`${API}/college/marks/${id}`, { method: 'DELETE' }); addMarks(studId); }

    // --- OTHER UI ACTIONS ---
 // --- 1. VIEW FEE SUMMARY & HISTORY ---
async function checkFees(studId) {
    try {
        const res = await fetch(`${API}/college/fees/student/${studId}`);
        
        if (res.status === 404) {
            // If no record exists, we offer to set up the billing (Total Fees)
            return openModal("Fee Management", `
                <div class="text-center py-10">
                    <i class="fas fa-file-invoice-dollar text-4xl text-slate-200 mb-4"></i>
                    <p class="text-slate-500 font-bold">No fee record found for this student.</p>
                    <button onclick="initFeeUI(${studId})" class="mt-4 px-6 py-2 bg-slate-900 text-white rounded-xl font-bold">Initialize Billing</button>
                </div>
            `, false);
        }

        const fee = await res.json();
        // Payment history comes from your 'paymentHistory' list in Java
        const history = fee.paymentHistory || [];

        let content = `
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-900 rounded-2xl text-white">
                        <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Total + Exam</p>
                        <p class="text-xl font-black">‚Çπ${fee.totalAmount + (fee.examFees || 0)}</p>
                    </div>
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Total Paid</p>
                        <p class="text-xl font-black text-emerald-700">‚Çπ${fee.paidAmount}</p>
                    </div>
                </div>

                <div class="p-4 bg-red-50 rounded-2xl border-2 border-red-100 text-center">
                    <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest">Remaining Balance</p>
                    <p class="text-3xl font-black text-red-600">‚Çπ${fee.dueAmount}</p>
                </div>

                <div class="flex gap-2">
                    <button onclick="paymentFormUI(${studId})" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">
                        + Pay Fees
                    </button>
                    <button onclick="editBillingUI(${studId}, ${JSON.stringify(fee).replace(/"/g, '&quot;')})" class="px-4 bg-slate-100 text-slate-600 rounded-2xl">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>

                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Transaction History</p>
                    <div class="max-h-52 overflow-y-auto space-y-2 pr-2">
                        ${history.map(p => `
                            <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <div>
                                    <p class="font-black text-slate-800">‚Çπ${p.amountPaid}</p>
                                    <p class="text-[10px] text-slate-400 font-bold">${new Date(p.paymentDate).toLocaleDateString()}</p>
                                </div>
                                <button onclick="deletePayment(${p.id}, ${studId})" class="w-8 h-8 text-red-300 hover:text-red-600 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `).join('') || '<p class="text-center py-6 text-slate-300 italic">No payments yet.</p>'}
                    </div>
                </div>
            </div>`;
        openModal("Fee Administration", content, false);
    } catch (err) {
        console.error(err);
    }
}
    
//UI to set the Initial Course Fee
function initFeeUI(studId) {
    let content = `
        <div class="space-y-4">
            <div class="p-3 bg-amber-50 border border-amber-100 rounded-xl">
                <p class="text-[10px] font-bold text-amber-600 uppercase">First Time Setup</p>
                <p class="text-xs text-amber-700">Set the base tuition and exam fees to create this account.</p>
            </div>
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Total Tuition Fee</label>
                <input type="number" id="init-total" placeholder="e.g. 50000" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Exam Fee</label>
                <input type="number" id="init-exam" placeholder="e.g. 2000" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold">
            </div>
        </div>`;

    openModal("Initialize Student Account", content, true, () => {
        const total = document.getElementById('init-total').value;
        const exam = document.getElementById('init-exam').value;
        submitInitFee(studId, total, exam);
    });
}

async function submitInitFee(studId, total, exam) {
    try {
        // STEP 1: Create the record in DB using your /pay endpoint (which has orElseGet logic)
        // We send a 0 amount just to trigger the creation of the Fees object
        const createRes = await fetch(`${API}/college/fees/${studId}/pay?amount=0`, { method: 'POST' });

        if (!createRes.ok) throw new Error("Database failed to create record");

        // STEP 2: Now update the billing with the actual amounts
        const payload = {
            totalAmount: parseFloat(total) || 0,
            examFees: parseFloat(exam) || 0,
            paidAmount: 0
        };

        const updateRes = await fetch(`${API}/college/fees/update-billing/${studId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (updateRes.ok) {
            alert("Billing Assigned!");
            closeModal();
            checkFees(studId); // Refresh the student view
            loadUnassignedStudents(); // Refresh the dashboard list
        }
    } catch (err) {
        alert("Error: " + err.message);
    }
}
function editBillingUI(studId, fee) {
    let content = `
        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase">Total Course Fee</label>
                <input type="number" id="edit-total" class="w-full p-4 bg-slate-50 rounded-2xl font-bold" value="${fee.totalAmount}">
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase">Exam Fee</label>
                <input type="number" id="edit-exam" class="w-full p-4 bg-slate-50 rounded-2xl font-bold" value="${fee.examFees}">
            </div>
        </div>`;

    openModal("Edit Billing", content, true, async () => {
        const payload = {
            totalAmount: parseFloat(document.getElementById('edit-total').value),
            examFees: parseFloat(document.getElementById('edit-exam').value),
            paidAmount: fee.paidAmount // Keep existing payments
        };

        const res = await fetch(`${API}/college/fees/update-billing/${studId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Billing Updated!");
            checkFees(studId);
        }
    });
}
// --- 2. PAYMENT COLLECTION UI ---
function paymentFormUI(studId) {
    let content = `
        <div class="space-y-4">
            <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Payment Portal</p>
                <p class="font-bold text-blue-800 italic">Processing for Student ID: #${studId}</p>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Enter Amount to Pay</label>
                <input type="number" id="p-amount" placeholder="0.00" 
                       class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-black text-xl focus:ring-4 focus:ring-blue-100 transition-all">
            </div>
        </div>`;
    
    // We pass the submit function directly to the modal helper
    openModal("Add Payment", content, true, () => submitPayment(studId));
}
// --- 3. SUBMIT NEW PAYMENT ---
// --- 2. THE SUBMIT FUNCTION (Matches your Java @PostMapping) ---
async function submitPayment(studId) {
    // 1. Find the element first
    const amountInput = document.getElementById('p-amount');
    
    // 2. Error Check: If the input doesn't exist in the DOM
    if (!amountInput) {
        console.error("Input 'p-amount' not found in DOM");
        return;
    }

    const amount = amountInput.value;
    
    if (!amount || amount <= 0) {
        alert("Please enter a valid amount.");
        return;
    }

    // 3. Prepare URL for your @RequestParam backend
    const url = `${API}/college/fees/${studId}/pay?amount=${amount}`;

    try {
        const res = await fetch(url, { 
            method: 'POST',
            // If you use Spring Security, you might need to include credentials
            headers: { 'Accept': 'application/json' } 
        });

        if (res.status === 401) {
            alert("Session expired. Please login again.");
            return;
        }

        if (res.ok) {
            // Your backend returns the Fee object, but we need to check if it's valid JSON
            const text = await res.text();
            try {
                JSON.parse(text);
                alert("Payment Success!");
                closeModal(); // Close the modal only AFTER success
                checkFees(studId); // Refresh list
            } catch (e) {
                // If it's not JSON, it might just be a success string
                alert("Payment Recorded");
                closeModal();
                checkFees(studId);
            }
        } else {
            alert("Server error. Please try again.");
        }
    } catch (err) {
        console.error("Fetch error:", err);
    }
}
// --- 4. DELETE PAYMENT (The Admin Function) ---
async function deletePayment(paymentId, studId) {
    if (!confirm("Are you sure you want to delete this payment record? This will increase the student's balance due.")) return;

    try {
        const res = await fetch(`${API}/college/fees/payment/${paymentId}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            alert("Payment deleted.");
            checkFees(studId); // Refresh the list and totals
        } else {
            alert("Could not delete record. It may have already been removed.");
        }
    } catch (err) {
        console.error("Delete Error:", err);
    }
}
    async function submitFee(studId, feeId = null) {
        const payload = {
            totalAmount: parseFloat(document.getElementById('f-total').value),
            paidAmount: parseFloat(document.getElementById('f-paid').value)
        };

        // Use your FeeController mapping (assuming POST for add and PUT/POST for update)
        const url = feeId ? `${API}/college/fees/update/${feeId}` : `${API}/college/fees/add/${studId}`;
        const method = feeId ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("Fee record updated successfully!");
            checkFees(studId); // Return to the summary view
        }
    }
    
    

   
    async function deleteFeeRecord(feeId, studId) {
        if(!confirm("Are you sure? This will wipe the student's financial history.")) return;
        const res = await fetch(`${API}/college/fees/delete/${feeId}`, { method: 'DELETE' });
        if(res.ok) {
            alert("Fee Record Removed");
            checkFees(studId);
        }
    }
    function feeFormUI(studId, data = null) {
        const isEdit = !!data;
        let content = `
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Total Course Fee</label>
                    <input type="number" id="f-total" class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none mt-1" value="${isEdit ? data.totalAmount : 0}">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Amount Paid to Date</label>
                    <input type="number" id="f-paid" class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none mt-1" value="${isEdit ? data.paidAmount : 0}">
                </div>
            </div>
        `;
        openModal(isEdit ? "Update Fee Record" : "New Fee Record", content, true, () => submitFee(studId, data?.feeId));
    }
    async function viewParents(studId) {
        const res = await fetch(`${API}/college/parents/student/${studId}`);
        const parents = await res.json();
        let content = `<div class="space-y-4">${parents.map(p => `
            <div class="p-4 bg-purple-50 rounded-2xl border border-purple-100 flex items-center gap-4">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center text-white"><i class="fas fa-phone"></i></div>
                <div><p class="font-bold text-purple-900">${p.parentName}</p><p class="text-xs font-bold text-purple-400 uppercase">${p.phone}</p></div>
            </div>`).join('') || 'None'}</div>`;
        openModal("Guardian Info", content, false);
    }

    async function studentDetails(studId) {
        const res = await fetch(`${API}/college/students/${studId}`);
        const s = await res.json();
        let content = `
            <div class="space-y-4 font-medium text-slate-600">
                <div class="flex justify-between border-b pb-2"><span>Full Name:</span><span class="font-bold text-slate-800">${s.fullName}</span></div>
                <div class="flex justify-between border-b pb-2"><span>Email:</span><span class="font-bold text-slate-800">${s.email}</span></div>
                <div class="flex justify-between border-b pb-2"><span>Phone:</span><span class="font-bold text-slate-800">${s.phone}</span></div>
                <div class="flex justify-between border-b pb-2"><span>Address:</span><span class="font-bold text-slate-800 text-right text-xs">${s.address}</span></div>
            </div>`;
        openModal("Full Student Profile", content, false);
    }

   

    async function processAssignment() {
        const selected = document.querySelectorAll('.stu-check:checked');
        const ids = Array.from(selected).map(c => parseInt(c.value));
        if (ids.length === 0) return alert("Select students first.");

        try {
            const res = await fetch(`${API}/api/faculty/${faculty.id}/assign-students`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(ids)
            });
            if (res.ok) {
                alert("Assignment Successful!");
                showTab('students', document.querySelector('[onclick*="students"]'));
            }
        } catch (e) { alert("Error assigning students"); }
    }
    function populateProfile() {
        document.getElementById('profName').value = faculty.name;
        document.getElementById('profId').value = faculty.facultyId;
        document.getElementById('profSub').value = faculty.subject;
        document.getElementById('profSal').value = faculty.salary || 0;
    }

    async function updateProfile() {
        const payload = {
            name: document.getElementById('profName').value,
            subject: document.getElementById('profSub').value,
            salary: parseFloat(document.getElementById('profSal').value),
            facultyId: document.getElementById('profId').value,
            password: document.getElementById('profPass').value
        };
        const res = await fetch(`${API}/api/faculty/${faculty.id}/update-profile`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (res.ok) {
            faculty = await res.json();
            localStorage.setItem('facultySession', JSON.stringify(faculty));
            refreshHeader(); alert("Profile Updated!");
        }
    }

    async function viewTodayAbsentees() {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`${API}/college/attendance/all?date=${today}`);
        const records = await res.json();
        const facultyStudentIds = allAssignedStudents.map(s => s.studId);
        const absentees = records.filter(r => r.status === 'ABSENT' && facultyStudentIds.includes(r.student.studId));
        
        let content = `<div class="space-y-2">${absentees.map(a => `
            <div class="flex justify-between items-center p-4 bg-red-50 rounded-2xl border border-red-100">
                <span class="font-bold text-red-800">${a.student.fullName}</span>
                <button onclick="updateAttendanceStatus(${a.attendId}, 'PRESENT', ${a.student.studId})" class="text-[10px] font-black uppercase bg-white px-3 py-1 rounded-lg border border-red-200">Revert</button>
            </div>`).join('') || '<p class="text-center py-6 text-slate-400 font-bold">No absentees yet.</p>'}</div>`;
        openModal("System Absentee List", content, false);
    }
    
 // --- THE MAIN ENGINE ---
    function downloadExcel(data, fileName) {
        if (!data || data.length === 0) {
            alert("No data available to download");
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data_Export");
        XLSX.writeFile(workbook, `${fileName}.xlsx`);
    }

    // --- EXAMINATION CENTER EXPORT ---
    async function exportExamResults() {
        try {
            const res = await fetch(`${API}/college/academic/all`); // Or your specific exam endpoint
            const records = await res.json();
            
            const exportData = records.map(r => ({
                "Student ID": r.student?.studId,
                "Student Name": r.student?.name,
                "Course": r.courseName,
                "Year": r.currentYear,
                "Result": r.status
            }));

            downloadExcel(exportData, "Examination_Report_" + new Date().toLocaleDateString());
        } catch (err) {
            alert("Exam Export Failed: Check if 'All Academic' endpoint is active.");
        }
    }
    function feeAdminUI() {
        let content = `
            <div class="flex justify-between items-center bg-emerald-50 p-4 rounded-2xl mb-4">
                <div>
                    <h3 class="font-black text-emerald-800">Financial Records</h3>
                    <p class="text-[10px] text-emerald-600 uppercase font-bold">Export master ledger</p>
                </div>
                <button onclick="exportFees()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 shadow-lg shadow-emerald-100">
                    <i class="fas fa-file-excel"></i> DOWNLOAD EXCEL
                </button>
            </div>
            `;
        openModal("Fee Administration", content, false);
    }
    
 // Ensure this is outside any other curly braces { }
async function downloadMasterReport() {
            const btn = document.getElementById('masterBtn');
            const icon = document.getElementById('masterIcon');
            const text = document.getElementById('masterText');

            // Check if XLSX is ready
            if (typeof XLSX === 'undefined') {
                alert("Excel library blocked. Please refresh or check browser settings.");
                return;
            }

            try {
                // UI Loading State
                btn.disabled = true;
                icon.className = "fas fa-spinner fa-spin text-blue-400";
                text.innerText = "GENERATING...";

                // Fetching all data in parallel
                const [sRes, fRes, aRes] = await Promise.all([
                    fetch(`${API}/college/students/all`),
                    fetch(`${API}/college/fees/all`),
                    fetch(`${API}/college/academic/all`)
                ]);

                // Map results or empty array if failed
                const students = sRes.ok ? await sRes.json() : [];
                const fees = fRes.ok ? await fRes.json() : [];
                const academics = aRes.ok ? await aRes.json() : [];

                const wb = XLSX.utils.book_new();

                // 1. Students Sheet
                const wsStud = XLSX.utils.json_to_sheet(students.map(s => ({
                    ID: s.studId, Name: s.name, Dept: s.department, Email: s.email
                })));
                XLSX.utils.book_append_sheet(wb, wsStud, "Students");

                // 2. Fees Sheet (with nested data mapping)
                const wsFees = XLSX.utils.json_to_sheet(fees.map(f => ({
                    ID: f.student?.studId || "N/A", Name: f.student?.name || "N/A", 
                    Total: f.totalAmount, Paid: f.paidAmount, Due: f.dueAmount
                })));
                XLSX.utils.book_append_sheet(wb, wsFees, "Finance");

                // 3. Academic Sheet
                const wsAcad = XLSX.utils.json_to_sheet(academics.map(a => ({
                    ID: a.student?.studId || "N/A", Course: a.courseName, Year: a.currentYear, Status: a.status
                })));
                XLSX.utils.book_append_sheet(wb, wsAcad, "Academics");

                XLSX.writeFile(wb, "College_Master_Backup.xlsx");

            } catch (err) {
                console.error(err);
                alert("Master Export Failed: One or more server endpoints failed.");
            } finally {
                // Reset UI
                btn.disabled = false;
                icon.className = "fas fa-database text-blue-400";
                text.innerText = "MASTER EXCEL BACKUP";
            }
        }

        
        ///attendance 
        async function loadAttendanceHistory() {
    try {
        const res = await fetch(`${API}/college/attendance/all`);
        attMasterRecords = await res.json();
        applyAttendanceFilters();
    } catch (e) { console.error("History fail", e); }
}

// 3. APPLY FILTERS (Calendar & Search)
function applyAttendanceFilters() {
    const query = document.getElementById('attSearch').value.toLowerCase();
    const date = document.getElementById('attDate').value;
    
    const filtered = attMasterRecords.filter(r => {
        const name = (r.student?.fullName || "").toLowerCase();
        const dateMatch = date ? r.date === date : true;
        return name.includes(query) && dateMatch;
    });

    renderAttendanceTable(filtered);
}

// 4. THE SESSION MODAL (The Engine)
async function openAttendanceSession() {
    if (allAssignedStudents.length === 0) {
        return alert("You have no students assigned to start a session.");
    }

    let content = `
        <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
            <div class="p-4 bg-blue-50 border border-blue-100 rounded-2xl flex justify-between items-center mb-4 sticky top-0 z-10">
                <div>
                    <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest">Active Marking Session</p>
                    <p class="font-bold text-blue-800">${new Date().toLocaleDateString('en-GB')}</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] font-black text-slate-400 uppercase">Count</p>
                    <p class="font-bold text-slate-700">${allAssignedStudents.length} Students</p>
                </div>
            </div>
            ${allAssignedStudents.map(s => `
                <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-100 shadow-sm hover:border-blue-200 transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-slate-100 rounded-full flex items-center justify-center font-bold text-slate-500">${s.fullName[0]}</div>
                        <div>
                            <p class="font-black text-slate-800 leading-none">${s.fullName}</p>
                            <p class="text-[10px] font-bold text-slate-400 uppercase mt-1">ID: ${s.studId}</p>
                        </div>
                    </div>
                    <select class="session-status p-2 bg-slate-50 rounded-xl border-none outline-none font-black text-[10px] focus:ring-2 focus:ring-blue-500 cursor-pointer" data-sid="${s.studId}">
                        <option value="PRESENT" class="text-green-600">PRESENT</option>
                        <option value="ABSENT" class="text-red-600">ABSENT</option>
                        <option value="LATE" class="text-amber-600">LATE</option>
                    </select>
                </div>
            `).join('')}
        </div>`;

    openModal("Attendance Session", content, true, async () => {
        const selects = document.querySelectorAll('.session-status');
        const today = new Date().toISOString().split('T')[0]; // Format: YYYY-MM-DD
        const now = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

        let successCount = 0;
        let errorCount = 0;

        // Change button state to loading
        const submitBtn = document.getElementById('modalSubmit');
        const originalText = submitBtn.innerText;
        submitBtn.innerText = "Processing...";
        submitBtn.disabled = true;

        for (let sel of selects) {
            const sid = sel.dataset.sid;
            const payload = {
                date: today,
                time: now,
                status: sel.value,
                student: { studId: parseInt(sid) } // Ensure ID is a number
            };

            try {
                const response = await fetch(`${API}/college/attendance/mark/${sid}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    successCount++;
                } else {
                    console.error(`Failed for ID ${sid}:`, await response.text());
                    errorCount++;
                }
            } catch (err) {
                console.error("Network Error:", err);
                errorCount++;
            }
        }

        submitBtn.innerText = originalText;
        submitBtn.disabled = false;

        if (errorCount > 0) {
            alert(`Completed with issues: ${successCount} saved, ${errorCount} failed. Check console for details.`);
        } else {
            alert("All attendance records saved successfully!");
            closeModal();
            if (typeof loadAttendanceHistory === "function") loadAttendanceHistory();
        }
    });
}

// 5. RENDER HISTORY TABLE
function renderAttendanceTable(data) {
    const body = document.getElementById('attendanceHistoryBody');
    body.innerHTML = data.map(r => `
        <tr class="hover:bg-slate-50 transition-all">
            <td class="px-8 py-4">
                <p class="font-black text-slate-800">${r.date}</p>
                <p class="text-[10px] text-slate-400 font-bold">${r.time || '00:00'}</p>
            </td>
            <td class="px-8 py-4">
                <p class="font-bold text-blue-600">${r.student?.fullName || 'Unknown'}</p>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">ID: ${r.student?.studId}</p>
            </td>
            <td class="px-8 py-4">
                <span class="px-3 py-1 rounded-full text-[10px] font-black ${r.status === 'PRESENT' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">
                    ${r.status}
                </span>
            </td>
            <td class="px-8 py-4 text-right">
                <button onclick="deleteAttendanceRecord(${r.attendId})" class="text-red-300 hover:text-red-500 transition-all">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </td>
        </tr>
    `).join('') || `<tr><td colspan="4" class="p-10 text-center text-slate-300 italic">No records found.</td></tr>`;
}

// 6. EXCEL EXPORT (Includes Student Name)
function downloadAttendanceExcel() {
    const exportData = attMasterRecords.map(r => ({
        "Date": r.date,
        "Time": r.time,
        "Student ID": r.student?.studId,
        "Student Name": r.student?.fullName,
        "Status": r.status
    }));
    
    const ws = XLSX.utils.json_to_sheet(exportData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Attendance_Log");
    XLSX.writeFile(wb, `Attendance_Report_${new Date().toLocaleDateString()}.xlsx`);
}

async function deleteAttendanceRecord(id) {
    if(!confirm("Are you sure?")) return;
    await fetch(`${API}/college/attendance/delete/${id}`, { method: 'DELETE' });
    loadAttendanceHistory();
}

/**
 * Global Tab Controller
 * @param {string} view - The ID suffix of the target view (e.g., 'assignments')
 * @param {HTMLElement} btn - The clicked navigation element
 */
function showTab(view, btn) {
    // 1. VISUAL RESET
    // Hide all sections and remove the 'active' styling from all nav links
    document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(n => {
        n.classList.remove('active', 'bg-slate-900', 'text-white');
        n.classList.add('text-slate-500');
    });

    // 2. ACTIVATE TARGET VIEW
    const targetView = document.getElementById(`view-${view}`);
    if (targetView) {
        targetView.classList.remove('hidden');
        // Add a small entry animation if you have the CSS
        targetView.classList.add('fade-in-up');
    }

    // 3. ACTIVATE BUTTON
    if (btn) {
        btn.classList.add('active', 'bg-slate-900', 'text-white');
        btn.classList.remove('text-slate-500');
    }

    // 4. DYNAMIC HEADER UPDATES
    const titleMap = {
        'students': 'Student Management',
        'assignments': 'Assignment Grading',
        'attendance': 'Attendance Records',
        'assign': 'Assign New Students',
        'profile': 'Faculty Profile'
    };
    
    document.getElementById('viewTitle').innerText = titleMap[view] || view.toUpperCase();

    // 5. COMPONENT TOGGLING
    // Show stats and search only for relevant data views
    const stats = document.getElementById('stats-container');
    const search = document.getElementById('search-section');
    
    const isDataView = ['students', 'assignments'].includes(view);
    if (stats) stats.classList.toggle('hidden', !isDataView);
    if (search) search.classList.toggle('hidden', !isDataView);

    // 6. DATA ROUTING (The "Engine")
    // Trigger the specific Fetch function based on the active tab
    console.log(`--- Routing to: ${view} ---`);
    
    switch(view) {
        case 'students':
            loadAssigned();
            break;
        case 'assignments':
            loadAllAssignments(); // Critical for your NeonDB grading table
            break;
        case 'attendance':
            loadAttendanceHistory();
            break;
        case 'assign':
            loadUnassignedStudents();
            break;
        case 'profile':
            if (typeof populateProfile === 'function') populateProfile();
            break;
        default:
            console.warn("View data loader not defined for:", view);
    }
}///Notes Session

// Add 'notes' to your showTab routing
// if (view === 'notes') { loadNoteViewData(); }

async function loadNoteViewData() {
    populateNoteDropdown();
    fetchSentNotes();
}

// Fill the dropdown with the faculty's assigned students
// --- 1. POPULATE DROPDOWN ---
function populateNoteDropdown() {
    const select = document.getElementById('noteRecipient');
    if (!select) return;

    // Uses the global allAssignedStudents from your loadAssigned() call
    if (allAssignedStudents.length === 0) {
        select.innerHTML = '<option value="">No assigned students available</option>';
        return;
    }

    select.innerHTML = '<option value="">Choose a student...</option>' + 
        allAssignedStudents.map(s => `
            <option value="${s.studId}">${s.fullName} (${s.course})</option>
        `).join('');
}
//--- 2. FILE LABEL FEEDBACK ---
function updateNoteLabel(input) {
    const label = document.getElementById('noteFileLabel');
    const icon = document.getElementById('uploadIcon');
    if (input.files.length > 0) {
        label.innerText = `SELECTED: ${input.files[0].name}`;
        label.classList.replace('text-slate-400', 'text-blue-600');
        icon.classList.replace('text-slate-300', 'text-blue-500');
    }
}

//--- 3. HANDLE UPLOAD (POST TO NEON DB) ---
async function handleNotePost() {
    const studId = document.getElementById('noteRecipient').value;
    const title = document.getElementById('noteTitle').value;
    const fileInput = document.getElementById('noteFile');
    const file = fileInput.files[0];
    const btn = document.getElementById('btnPostNote');

    if (!studId || !title || !file) {
        alert("‚ö†Ô∏è Please fill all fields and select a document.");
        return;
    }

    // Prepare Multipart Data
    const formData = new FormData();
    formData.append("facultyId", faculty.id); // From current faculty session
    formData.append("studId", studId);
    formData.append("title", title);
    formData.append("file", file);

    btn.disabled = true;
    btn.innerText = "UPLOADING...";

    try {
        const res = await fetch(`${API}/api/notes/upload`, {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            alert("‚úÖ Note shared successfully with student portal!");
            resetNoteForm();
            fetchSentNotes(); // Refresh history table
        } else {
            alert("‚ùå Upload failed. Max file size is likely 10MB.");
        }
    } catch (err) {
        console.error("Note Upload Error:", err);
    } finally {
        btn.disabled = false;
        btn.innerText = "POST TO STUDENT PORTAL";
    }
}

//--- 4. FETCH HISTORY ---
async function fetchSentNotes() {
    const tbody = document.getElementById('notesHistoryTable');
    try {
        const res = await fetch(`${API}/api/notes/faculty/${faculty.id}`);
        const notes = await res.json();

        tbody.innerHTML = notes.map(n => `
            <tr class="hover:bg-slate-50 transition-all border-l-4 border-transparent hover:border-blue-500">
                <td class="px-8 py-5 text-[10px] font-black text-slate-400 uppercase">
                    ${new Date(n.uploadDate).toLocaleDateString()}
                </td>
                <td class="px-8 py-5">
                    <p class="font-bold text-slate-800">${n.student.fullName}</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase">${n.student.course}</p>
                </td>
                <td class="px-8 py-5">
                    <p class="text-sm font-black text-slate-800">${n.title}</p>
                    <p class="text-[10px] text-blue-500 font-bold uppercase tracking-widest">${n.fileName}</p>
                </td>
                <td class="px-8 py-5 text-right">
                    <a href="${API}/api/notes/view/${n.id}" target="_blank" class="w-10 h-10 inline-flex items-center justify-center bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all shadow-sm">
                        <i class="fas fa-eye"></i>
                    </a>
                </td>
            </tr>
        `).join('');
    } catch (err) {
        tbody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-300 font-bold">No history available.</td></tr>';
    }
}

function resetNoteForm() {
    document.getElementById('noteTitle').value = "";
    document.getElementById('noteFile').value = "";
    const label = document.getElementById('noteFileLabel');
    label.innerText = "Click to browse files (PDF, DOCX)";
    label.classList.replace('text-blue-600', 'text-slate-400');
    document.getElementById('uploadIcon').classList.replace('text-blue-500', 'text-slate-300');
}

///assignment
let assignments = []; 
let activeReviewId = null;

// FETCH ALL SUBMISSIONS
async function loadAllAssignments() {
    const tbody = document.getElementById('facultyAssignmentTable');
    try {
        const res = await fetch(`${API}/api/assignments/all`);
        
        if (!res.ok) {
            const errorData = await res.text();
            throw new Error(`Server Error (${res.status}): ${errorData || 'NeonDB Connection Failed'}`);
        }
        
        assignments = await res.json();
        renderAssignmentTable(assignments);
    } catch (e) {
        console.error("Assignment Fetch Error:", e);
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="py-12 text-center">
                        <div class="flex flex-col items-center gap-2">
                            <i class="fas fa-exclamation-triangle text-rose-500 text-2xl"></i>
                            <p class="text-rose-600 font-black uppercase text-xs tracking-widest">NeonDB Connection Failed</p>
                            <p class="text-slate-400 text-[10px] italic">${e.message}</p>
                            <button onclick="loadAllAssignments()" class="mt-2 px-4 py-2 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-bold hover:bg-slate-200 transition">RETRY CONNECTION</button>
                        </div>
                    </td>
                </tr>`;
        }
    }
}
// RENDER THE TABLE
function renderAssignmentTable(dataToRender) {
    const tbody = document.getElementById('facultyAssignmentTable');
    if (!tbody) return;

    if (!dataToRender || dataToRender.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="py-20 text-center opacity-40 font-black italic">No Submissions Found</td></tr>`;
        return;
    }

    tbody.innerHTML = dataToRender.map(a => {
        const dateDisplay = a.submissionDate ? new Date(a.submissionDate).toLocaleDateString() : "Pending";
        const statusClass = a.status === 'Graded' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600';

        return `
            <tr class="bg-white hover:bg-slate-50 transition-all border-b border-slate-50 shadow-sm group">
                <td class="px-6 py-5 rounded-l-3xl">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg">
                            ${a.student ? a.student.fullName[0] : 'S'}
                        </div>
                        <div>
                            <p class="font-black text-slate-800 text-xs uppercase">${a.student ? a.student.fullName : 'Unknown Student'}</p>
                            <p class="text-[9px] text-slate-400 font-bold uppercase tracking-tighter">ID: ${a.student ? a.student.studId : 'N/A'}</p>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-5 font-bold text-slate-700 text-xs uppercase">${a.title || 'Assignment'}</td>
                <td class="px-6 py-5 text-[10px] font-black text-slate-400 uppercase italic">${dateDisplay}</td>
                <td class="px-6 py-5">
                    <div class="flex flex-col gap-1">
                        <span class="px-3 py-1 rounded-lg text-[9px] font-black uppercase text-center ${statusClass}">
                            ${a.status || 'Submitted'}
                        </span>
                        ${a.marks ? `<span class="text-[10px] font-black text-center text-slate-800 tracking-tighter">${a.marks}/100</span>` : ''}
                    </div>
                </td>
                <td class="px-6 py-5 text-right rounded-r-3xl">
                    <button onclick="openGradeModal(${a.id})" class="h-10 w-10 bg-slate-900 text-white rounded-xl hover:bg-blue-600 hover:shadow-lg transition-all flex items-center justify-center ml-auto shadow-md">
                        <i class="fas fa-edit text-xs"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// OPEN MODAL & POPULATE DATA
function openGradeModal(id) {
    const a = assignments.find(x => x.id === id);
    if (!a) return;
    activeReviewId = id;

    // 1. Fill Text Details
    document.getElementById('revTitle').innerText = a.title || "Untitled Task";
    document.getElementById('revContent').innerText = a.description || "No description provided.";

    // 2. Fill Input Values
    document.getElementById('gradeMarks').value = a.marks !== null ? a.marks : "";
    document.getElementById('gradeStatus').value = a.status || "Submitted";
    document.getElementById('gradeFeedback').value = a.feedback || "";

    // 3. Setup the Action Button (Now triggers Preview)
    const btn = document.getElementById('downloadBtn');
    
    if (a.content && a.content.includes("base64")) {
        // Change: Instead of download logic, we call previewSubmission
        btn.onclick = () => previewSubmission(a.content, a.title);
        
        btn.innerHTML = `<i class="fas fa-eye mr-2 text-lg"></i> PREVIEW SUBMISSION`;
        btn.className = "flex-1 bg-indigo-600 text-white py-5 rounded-3xl font-black text-xs hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center";
    } else {
        btn.onclick = () => alert("Student did not upload any file.");
        btn.innerHTML = `<i class="fas fa-eye-slash mr-2 text-lg"></i> NO FILE ATTACHED`;
        btn.className = "flex-1 bg-slate-100 text-slate-400 py-5 rounded-3xl font-black text-xs cursor-not-allowed flex items-center justify-center";
    }

    // 4. Show the Review Modal
    document.getElementById('gradeModal').classList.remove('hidden');
}// SUBMIT TO SPRING BOOT
async function submitGrade() {
    const marksInput = document.getElementById('gradeMarks').value;
    const statusInput = document.getElementById('gradeStatus').value;
    const feedbackInput = document.getElementById('gradeFeedback').value;

    // Use setBtnLoading if you have it in your faculty script
    const submitBtn = document.querySelector("#gradeModal button[type='submit']");
    if(submitBtn) submitBtn.disabled = true;

    const payload = {
        status: statusInput,
        feedback: feedbackInput,
        marks: marksInput === "" ? null : parseInt(marksInput)
    };

    try {
        const res = await fetch(`${API}/api/assignments/update/${activeReviewId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            closeGradeModal();
            await loadAllAssignments(); 
            alert("Grade Saved Successfully!");
        } else {
            throw new Error("Failed to update grade on server.");
        }
    } catch (err) {
        console.error("Update failed", err);
        alert("Error: Could not save grade. Check console for details.");
    } finally {
        if(submitBtn) submitBtn.disabled = false;
    }
}function closeGradeModal() { document.getElementById('gradeModal').classList.add('hidden'); }

// CSV EXPORT LOGIC
function exportAssignmentsToExcel() {
    if (assignments.length === 0) return alert("No data to export.");
    const headers = ["Student", "ID", "Title", "Date", "Status", "Marks", "Feedback"];
    const rows = assignments.map(a => [
        a.student?.fullName || "N/A", a.student?.studId || "N/A",
        `"${a.title}"`, new Date(a.submissionDate).toLocaleDateString(),
        a.status, a.marks || 0, `"${a.feedback || ''}"`
    ]);
    const csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(r => r.join(",")).join("\n");
    const link = document.createElement("a");
    link.href = encodeURI(csvContent);
    link.download = `Faculty_Grades_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function previewSubmission(base64, title) {
    const modal = document.getElementById('previewModal');
    const container = document.getElementById('previewContainer');
    const subtitle = document.getElementById('previewSubtitle');
    
    if (!modal || !container) return console.error("Modal elements not found!");

    document.getElementById('previewTitle').innerText = title || "Submission Preview";
    container.innerHTML = '<p class="mt-20 font-bold text-slate-400 animate-pulse">GENERATING PREVIEW...</p>'; 
    modal.classList.remove('hidden');

    try {
        if (!base64 || base64.length < 50) {
            throw new Error("No valid file data found.");
        }

        const mimeType = base64.split(';')[0].split(':')[1];
        
        // 1. Handle PDF
        if (mimeType === "application/pdf") {
            subtitle.innerText = "Official PDF Document";
            // Convert Base64 to Blob URL for better browser compatibility
            const blob = base64ToBlob(base64);
            const blobUrl = URL.createObjectURL(blob);
            container.innerHTML = `<iframe src="${blobUrl}" class="w-full h-full rounded-2xl bg-white shadow-2xl"></iframe>`;
        } 
        // 2. Handle CSV
        // Inside previewSubmission function...
else if (base64.includes("text/csv") || base64.includes("base64,U3R1ZGVud")) {
    subtitle.innerText = "Spreadsheet / CSV Data";
    // Extract the base64 string, decode it to raw text (atob), then pass to our helper
    const rawCSV = atob(base64.split(',')[1]); 
    container.innerHTML = formatCSVtoTable(rawCSV); // <--- This calls the function above
}
        // 3. Handle Images
        else if (mimeType.startsWith("image/")) {
            subtitle.innerText = "Image Upload";
            container.innerHTML = `<img src="${base64}" class="max-w-full h-auto rounded-2xl shadow-2xl">`;
        }
    } catch (err) {
        container.innerHTML = `<div class="bg-white p-10 rounded-3xl text-center"><i class="fas fa-exclamation-circle text-rose-500 text-3xl mb-4"></i><p class="font-bold text-slate-800">${err.message}</p></div>`;
    }
}

// Helper: Convert Base64 to Blob
function base64ToBlob(base64) {
    try {
        // Handle strings with or without the 'data:' prefix
        const parts = base64.includes(';base64,') 
            ? base64.split(';base64,') 
            : [null, base64];
            
        const contentType = parts[0] ? parts[0].split(':')[1] : 'application/octet-stream';
        const raw = window.atob(parts[1]);
        const u8arr = new Uint8Array(raw.length);
        
        for (let i = 0; i < raw.length; i++) {
            u8arr[i] = raw.charCodeAt(i);
        }
        
        return new Blob([u8arr], { type: contentType });
    } catch (e) {
        console.error("Blob conversion failed:", e);
        return null;
    }
}// Helper to turn raw CSV text into a beautiful Tailwind table
function formatCSVtoTable(csvText) {
    const rows = csvText.split('\n').filter(row => row.trim() !== '');
    if (rows.length === 0) return '<p class="p-10 text-slate-400 font-bold">The file is empty.</p>';

    let html = `
        <div class="bg-white rounded-3xl shadow-xl p-6 w-full overflow-hidden border border-slate-100 scale-in-center">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                        <tr>`;
    
    // Process Header Row
    const headers = rows[0].split(',');
    headers.forEach(h => {
        html += `<th class="px-6 py-4 border-b border-slate-100">${h.trim()}</th>`;
    });

    html += `</tr></thead><tbody class="text-xs font-bold text-slate-600">`;

    // Process Data Rows
    rows.slice(1).forEach(row => {
        const cells = row.split(',');
        html += `<tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">`;
        cells.forEach(cell => {
            html += `<td class="px-6 py-4">${cell.trim()}</td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table></div></div>`;
    return html;
}
function closePreview() {
    document.getElementById('previewModal').classList.add('hidden');
    document.getElementById('previewContainer').innerHTML = ''; // Memory cleanup
}

function printPreview() {
    const container = document.getElementById('previewContainer');
    const iframe = container.querySelector('iframe');
    
    // If it's a PDF already in an iframe, print it directly
    if (iframe) {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        return;
    }

    // If it's a CSV Table or Image, we print the specific element
    // This avoids the 'TrustedScript' block by not using document.write
    const content = container.innerHTML;
    const printFrame = document.createElement('iframe');
    
    // Style the hidden frame
    printFrame.style.position = 'fixed';
    printFrame.style.right = '0';
    printFrame.style.bottom = '0';
    printFrame.style.width = '0';
    printFrame.style.height = '0';
    printFrame.style.border = '0';
    
    document.body.appendChild(printFrame);
    
    const doc = printFrame.contentWindow.document;
    
    // We use a simple structure that doesn't trigger security blocks
    doc.open();
    doc.write(`
        <!DOCTYPE html>
        <html>
            <head>
                <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
                <style>@media print { .no-print { display: none; } }</style>
            </head>
            <body onload="window.print();">
                <div class="p-8">${content}</div>
            </body>
        </html>
    `);
    doc.close();

    // Cleanup after printing
    setTimeout(() => {
        document.body.removeChild(printFrame);
    }, 1000);
}
    function handleLogout() { localStorage.clear(); window.location.href = "faculty-auth.html"; }
    </script>
</body>
</html>