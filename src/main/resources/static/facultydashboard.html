<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faculty Dashboard | COLLEGE.io</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; color: #1e293b; }
        
        .nav-item.active { background-color: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        .action-btn-styled {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 0.75rem; border-radius: 1.25rem; transition: all 0.2s ease;
        }

        .content-view { animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="pb-24 md:pb-0">

    <div class="min-h-screen flex flex-col md:flex-row">
        <aside class="fixed bottom-0 left-0 w-full bg-white/80 backdrop-blur-md border-t border-slate-200 z-[100] md:relative md:w-72 md:border-t-0 md:border-r md:h-screen md:bg-white">
            <div class="hidden md:block p-8 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white">
                        <i class="fas fa-university"></i>
                    </div>
                    <span class="text-xl font-black text-slate-800 tracking-tight">COLLEGE.io</span>
                </div>
            </div>
            
            <nav class="flex flex-row md:flex-col justify-around md:justify-start p-3 md:p-6 gap-2">
                <button onclick="showTab('students', this)" class="nav-item active flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1">
                    <i class="fas fa-columns"></i>
                    <span class="text-[10px] md:text-sm font-bold">Overview</span>
                </button>
                <button onclick="showTab('assign', this)" class="nav-item flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1">
                    <i class="fas fa-user-plus"></i>
                    <span class="text-[10px] md:text-sm font-bold">Assign</span>
                </button>
                <button onclick="showTab('profile', this)" class="nav-item flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 rounded-2xl transition-all flex-1">
                    <i class="fas fa-fingerprint"></i>
                    <span class="text-[10px] md:text-sm font-bold">Profile</span>
                </button>
                <button onclick="handleLogout()" class="flex flex-col md:flex-row items-center gap-1 md:gap-4 p-3 text-red-500 rounded-2xl flex-1 md:mt-20 hover:bg-red-50 transition-all">
                    <i class="fas fa-power-off"></i>
                    <span class="text-[10px] md:text-sm font-bold">Logout</span>
                </button>
            </nav>
        </aside>

        <main class="flex-1 p-4 md:p-12 overflow-y-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                <div>
                    <h2 id="viewTitle" class="text-4xl font-black text-slate-900 tracking-tight">Dashboard</h2>
                    <p id="facultySub" class="text-slate-500 font-medium mt-1">Faculty Portal Access</p>
                </div>
                <div class="flex items-center gap-4 bg-white p-2 pr-6 rounded-2xl shadow-sm border border-slate-100">
                    <div id="facultyInitial" class="w-12 h-12 bg-blue-100 text-blue-600 rounded-xl flex items-center justify-center font-bold text-xl">F</div>
                    <div>
                        <p id="facultyNameDisplay" class="font-bold text-slate-800 text-sm">Faculty Member</p>
                        <p class="text-[10px] text-green-500 font-bold uppercase tracking-widest">‚óè Online Now</p>
                    </div>
                    <button onclick="downloadMasterReport()" class="flex items-center gap-2 bg-slate-900 text-white px-6 py-3 rounded-2xl font-black text-xs tracking-widest hover:scale-105 transition-all">
    <i class="fas fa-database text-blue-400"></i> MASTER EXCEL BACKUP
</button>
                </div>
            </header>

            <div id="stats-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
                <div class="lg:col-span-2 glass-card p-6 rounded-[2rem] shadow-xl shadow-blue-900/5 flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="space-y-4">
                        <h3 class="text-xl font-bold text-slate-800">Today's Attendance</h3>
                        <div class="flex gap-6">
                            <div class="space-y-1">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Present</p>
                                <p id="label-present" class="text-2xl font-black text-green-500">0</p>
                            </div>
                            <div class="space-y-1">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Absent</p>
                                <p id="label-absent" class="text-2xl font-black text-red-500">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="relative w-32 h-32 flex items-center justify-center">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle cx="64" cy="64" r="50" stroke="#f1f5f9" stroke-width="12" fill="transparent" />
                            <circle id="progress-circle" cx="64" cy="64" r="50" stroke="#2563eb" stroke-width="12" fill="transparent" 
                                    stroke-dasharray="314.15" stroke-dashoffset="314.15" stroke-linecap="round" class="transition-all duration-1000" />
                        </svg>
                        <span id="perc-text" class="absolute text-xl font-black text-slate-800">0%</span>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-slate-900 to-slate-800 p-8 rounded-[2rem] text-white flex flex-col justify-between shadow-2xl">
                    <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest">Smart Scheduler</p>
                    <p class="text-sm font-medium mt-2 leading-relaxed">The system automatically logs absentees daily at <span class="text-blue-400 font-bold">4:01 PM</span>.</p>
                    <button onclick="viewTodayAbsentees()" class="mt-6 w-full py-3 bg-white/10 hover:bg-white/20 rounded-xl font-bold text-xs backdrop-blur-md transition-all border border-white/10">
                        View Absentees List
                    </button>
                </div>
            </div>

            <div id="search-section" class="mb-8">
                <div class="relative max-w-xl">
                    <i class="fas fa-search absolute left-5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="text" id="studentSearch" onkeyup="filterStudents()" 
                           placeholder="Search by name, ID or course..." 
                           class="w-full pl-14 pr-6 py-4 bg-white rounded-2xl border-none shadow-sm focus:ring-4 focus:ring-blue-100 outline-none transition-all font-medium">
                </div>
            </div>

            <div id="view-students" class="content-view grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>

            <div id="view-assign" class="content-view hidden">
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                        <div class="mt-8">
    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest mb-4">Unassigned Students</h3>
    <div id="unassigned-container">
        <p class="text-slate-300 animate-pulse">Scanning database...</p>
    </div>
</div>
                        <button onclick="processAssignment()" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-xl shadow-blue-200 transition-all active:scale-95">
                            Confirm Assignment
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-400 text-[10px] uppercase tracking-widest font-black">
                                <tr>
                                    <th class="px-8 py-5">Select</th>
                                    <th class="px-8 py-5">Full Name</th>
                                    <th class="px-8 py-5">Course</th>
                                </tr>
                            </thead>
                            <tbody id="unassignedList" class="divide-y divide-slate-100 font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-profile" class="content-view hidden">
                <div class="max-w-3xl glass-card rounded-[2.5rem] p-10 shadow-2xl">
                    <div class="mb-10 flex items-center gap-6">
                        <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center text-white text-3xl shadow-xl shadow-blue-200">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <div>
                            <h3 class="font-black text-3xl text-slate-800 tracking-tight">Faculty Settings</h3>
                            <p class="text-slate-500 font-medium">Management & Security Preference</p>
                        </div>
                    </div>
                    
                    <form id="profileForm" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Full Name</label>
                            <input type="text" id="profName" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none transition-all">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Faculty ID (Static)</label>
                            <input type="text" id="profId" class="w-full p-4 rounded-2xl bg-slate-100 border border-slate-200 text-slate-400" readonly>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Specialization Subject</label>
                            <input type="text" id="profSub" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none">
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Annual Salary</label>
                            <input type="number" id="profSal" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none">
                        </div>
                        <div class="space-y-2 col-span-full">
                            <label class="text-xs font-black text-slate-400 uppercase tracking-widest">Update Password</label>
                            <input type="password" id="profPass" placeholder="Leave blank to remain unchanged" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:ring-4 focus:ring-blue-50 outline-none">
                        </div>
                        <button type="button" onclick="updateProfile()" class="col-span-full bg-slate-900 text-white py-5 rounded-2xl font-black text-lg hover:bg-black hover:shadow-2xl transition-all mt-4">
                            Update Faculty Profile
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div id="actionModal" class="hidden fixed inset-0 z-[2000] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onclick="closeModal()"></div>
        <div class="relative bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden transform scale-100 transition-all">
            <div id="modalHeader" class="p-8 border-b flex justify-between items-center bg-slate-50/50">
                <h3 id="modalTitle" class="text-2xl font-black text-slate-800 tracking-tight">Action</h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-50 hover:text-red-500 transition-all">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="modalBody" class="p-8 max-h-[60vh] overflow-y-auto"></div>
            
            <div class="p-6 bg-slate-50/80 border-t flex justify-end gap-3 px-8">
                <button onclick="closeModal()" class="px-6 py-3 text-slate-600 font-bold hover:bg-slate-200 rounded-xl transition-all">Discard</button>
                <button id="modalSubmit" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all">Apply Changes</button>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.min.js"></script>
    <script>
    const API = "https://smart-college.onrender.com";
    let faculty = JSON.parse(localStorage.getItem('facultySession'));
    let allAssignedStudents = [];

    window.onload = () => {
        if (!faculty) {
            alert("Session expired. Please login.");
            window.location.href = "faculty-auth.html";
            return;
        }
        refreshHeader();
        loadAssigned();
    };

    function refreshHeader() {
        document.getElementById('facultySub').innerText = `${faculty.subject} | ID: ${faculty.facultyId}`;
        document.getElementById('facultyNameDisplay').innerText = faculty.name;
        document.getElementById('facultyInitial').innerText = faculty.name[0];
    }

    function showTab(view, btn) {
        document.querySelectorAll('.content-view').forEach(v => v.classList.add('hidden'));
        document.getElementById(`view-${view}`).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
        
        document.getElementById('viewTitle').innerText = view.charAt(0).toUpperCase() + view.slice(1);
        
        // Toggle visibility of Search & Stats bar only for Students tab
        document.getElementById('stats-container').classList.toggle('hidden', view !== 'students');
        document.getElementById('search-section').classList.toggle('hidden', view !== 'students');

        if (view === 'students') loadAssigned();
        if (view === 'assign') loadUnassigned();
        if (view === 'profile') populateProfile();
    }

    // --- CORE DATA FETCHING ---
    async function loadAssigned() {
        try {
            const res = await fetch(`${API}/api/faculty/${faculty.id}/students`);
            allAssignedStudents = await res.json();
            renderStudentCards(allAssignedStudents);
            updateAttendanceWidget();
        } catch (e) { console.error("Error loading students", e); }
    }
    

    function renderStudentCards(data) {
        const container = document.getElementById('view-students');
        if (data.length === 0) {
            container.innerHTML = `<div class="col-span-full py-20 text-center opacity-40 font-bold">No students found.</div>`;
            return;
        }
        container.innerHTML = data.map(s => `
            <div class="bg-white rounded-[2rem] border border-slate-200 shadow-sm overflow-hidden hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                <div class="p-6 bg-slate-50/50 border-b flex items-center gap-4">
                    <div class="w-14 h-14 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-2xl flex items-center justify-center text-white font-black text-xl shadow-lg shadow-blue-200">
                        ${s.fullName[0]}
                    </div>
                    <div>
                        <h4 class="font-black text-slate-800 leading-tight">${s.fullName}</h4>
                        <p class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mt-1">${s.course} ‚Ä¢ Year ${s.year}</p>
                    </div>
                </div>

                <div class="p-4 grid grid-cols-3 gap-2">
                    <button onclick="manageAttendance(${s.studId})" class="action-btn-styled text-blue-600 hover:bg-blue-50">
                        <i class="fas fa-calendar-check text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Attend</span>
                    </button>
                    <button onclick="viewAcademicRecords(${s.studId})" class="action-btn-styled text-indigo-600 hover:bg-indigo-50">
                        <i class="fas fa-file-invoice text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Records</span>
                    </button>
                    <button onclick="checkFees(${s.studId})" class="action-btn-styled text-emerald-600 hover:bg-emerald-50">
                        <i class="fas fa-wallet text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Fees</span>
                    </button>
                    <button onclick="addMarks(${s.studId})" class="action-btn-styled text-amber-600 hover:bg-amber-50">
                        <i class="fas fa-medal text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Marks</span>
                    </button>
                    <button onclick="viewParents(${s.studId})" class="action-btn-styled text-purple-600 hover:bg-purple-50">
                        <i class="fas fa-user-friends text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Parents</span>
                    </button>
                    <button onclick="studentDetails(${s.studId})" class="action-btn-styled text-slate-500 hover:bg-slate-100">
                        <i class="fas fa-info-circle text-lg mb-1"></i><span class="text-[9px] font-black uppercase">Info</span>
                    </button>
                </div>
            </div>
        `).join('');
    }

    // --- LATEST FUNCTION: FILTERING & SEARCH ---
    function filterStudents() {
        const query = document.getElementById('studentSearch').value.toLowerCase();
        const filtered = allAssignedStudents.filter(s => 
            s.fullName.toLowerCase().includes(query) || 
            s.studId.toString().includes(query) ||
            s.course.toLowerCase().includes(query)
        );
        renderStudentCards(filtered);
    }
    
    async function loadUnassignedStudents() {
        try {
            // 1. Get both lists from your backend
            const [studRes, feeRes] = await Promise.all([
                fetch(`${API}/college/students/all`),
                fetch(`${API}/college/fees/all`)
            ]);

            const students = await studRes.json();
            const fees = await feeRes.json();

            // 2. Identify IDs that ALREADY have fees
            // Check if your Fees object uses 'student.studId' or just 'studentId'
            const assignedIds = fees.map(f => f.student ? f.student.studId : null);

            // 3. Filter for students NOT in that ID list
            const unassigned = students.filter(s => !assignedIds.includes(s.studId));

            const container = document.getElementById('unassigned-container');
            if (!container) return;

            // 4. Render
            if (unassigned.length === 0) {
                container.innerHTML = `
                    <div class="p-8 text-center bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                        <p class="text-slate-400 font-bold italic">üéâ All students are assigned!</p>
                    </div>`;
            } else {
                container.innerHTML = unassigned.map(s => `
                    <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-100 shadow-sm mb-3 hover:border-blue-200 transition-all">
                        <div>
                            <p class="font-black text-slate-800">${s.name}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">ID: ${s.studId} ‚Ä¢ ${s.department}</p>
                        </div>
                        <button onclick="initFeeUI(${s.studId})" class="px-4 py-2 bg-blue-600 text-white text-[10px] font-black rounded-xl uppercase tracking-wider">
                            Assign Fees
                        </button>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error("Dashboard Load Error:", err);
        }
    }
    // --- LATEST FUNCTION: ATTENDANCE WIDGET ---
    async function updateAttendanceWidget() {
        const today = new Date().toISOString().split('T')[0];
        try {
            const res = await fetch(`${API}/college/attendance/all?date=${today}`);
            const records = await res.json();
            
            const facultyStudentIds = allAssignedStudents.map(s => s.studId);
            const myRecords = records.filter(r => facultyStudentIds.includes(r.student.studId));
            
            const present = myRecords.filter(r => r.status === 'PRESENT' || r.status === 'LATE').length;
            const total = allAssignedStudents.length;
            const absent = total - present;

            document.getElementById('label-present').innerText = present;
            document.getElementById('label-absent').innerText = absent;

            const percentage = total > 0 ? (present / total) * 100 : 0;
            const circle = document.getElementById('progress-circle');
            const circumference = 314.15; // 2 * PI * 50
            circle.style.strokeDashoffset = circumference - (percentage / 100) * circumference;
            document.getElementById('perc-text').innerText = `${Math.round(percentage)}%`;
        } catch(e) {}
    }

    // --- MODAL & CRUD LOGIC ---
   function openModal(title, content, showSubmit = true, submitCallback = null) {
    document.getElementById('modalTitle').innerText = title;
    document.getElementById('modalBody').innerHTML = content;
    document.getElementById('actionModal').classList.remove('hidden');
    
    const submitBtn = document.getElementById('modalSubmit');
    
    if (showSubmit) {
        submitBtn.style.display = 'block';
        // We clear old listeners and add the new one
        submitBtn.onclick = async () => {
            if (submitCallback) await submitCallback();
        };
    } else {
        submitBtn.style.display = 'none';
    }
}

    function closeModal() { document.getElementById('actionModal').classList.add('hidden'); }

    // --- ATTENDANCE ---
    async function manageAttendance(studId) {
        const res = await fetch(`${API}/college/attendance/history/${studId}`);
        const history = await res.json();
        let content = `
            <div class="space-y-4">
                <button onclick="submitAttendance(${studId}, 'PRESENT')" class="w-full p-4 bg-green-600 text-white rounded-2xl font-black shadow-lg shadow-green-100 transition-all active:scale-95">Mark Present (GPS Check)</button>
                <div class="border-t pt-4">
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3">Attendance History</p>
                    <div class="space-y-2">
                        ${history.slice(0, 5).map(h => `
                            <div class="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                                <span class="text-sm font-bold text-slate-600">${h.date}</span>
                                <select onchange="updateAttendanceStatus(${h.attendId}, this.value, ${studId})" class="text-xs font-black p-1 rounded-lg ${h.status === 'PRESENT' ? 'text-green-600' : 'text-red-600'}">
                                    <option value="PRESENT" ${h.status === 'PRESENT' ? 'selected' : ''}>PRESENT</option>
                                    <option value="ABSENT" ${h.status === 'ABSENT' ? 'selected' : ''}>ABSENT</option>
                                </select>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
        openModal("Attendance Center", content, false);
    }

    async function submitAttendance(studId, status) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const payload = { latitude: pos.coords.latitude, longitude: pos.coords.longitude, status: status };
            const res = await fetch(`${API}/college/attendance/mark/${studId}`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)
            });
            if(res.ok) { alert("Success!"); closeModal(); updateAttendanceWidget(); }
            else alert(await res.text());
        }, () => alert("Enable GPS to mark attendance."));
    }

    async function updateAttendanceStatus(attendId, newStatus, studId) {
        await fetch(`${API}/college/attendance/update/${attendId}?status=${newStatus}`, { method: 'PUT' });
        manageAttendance(studId);
        updateAttendanceWidget();
    }

    // --- ACADEMIC (Full CRUD) ---
   // --- VIEW RECORDS ---
async function viewAcademicRecords(studId) {
    try {
        const res = await fetch(`${API}/college/academic/student/${studId}`);
        
        // If the server still says 401, it means Spring Security is active
        if (res.status === 401) {
            return alert("Access Denied (401). Please check your Spring Security configuration.");
        }

        const records = await res.json();
        
        let content = `
            <div class="space-y-4">
                <button onclick="academicFormUI(${studId})" class="w-full p-3 bg-indigo-600 text-white rounded-2xl font-bold">+ Add New Academic Year</button>
                <div class="space-y-2">
                    ${records.map(r => `
                        <div class="p-4 bg-white rounded-2xl border border-slate-200 flex justify-between items-center shadow-sm">
                            <div>
                                <p class="font-black text-slate-800">${r.courseName}</p>
                                <p class="text-[10px] text-slate-500 font-bold uppercase">${r.academicYear} ‚Ä¢ Year ${r.currentYear} ‚Ä¢ ${r.status}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick='academicFormUI(${studId}, ${JSON.stringify(r)})' class="w-8 h-8 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteAcademic(${r.id}, ${studId})" class="w-8 h-8 bg-red-50 text-red-600 rounded-lg"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `).join('') || '<p class="text-center text-slate-400 py-6">No history found.</p>'}
                </div>
            </div>`;
        openModal("Academic Management", content, false);
    } catch (err) {
        console.error(err);
    }
}
    
   async function deleteAcademic(recordId, studId) {
	    if(!confirm("Are you sure you want to delete this academic record?")) return;
	    const res = await fetch(`${API}/college/academic/delete/${recordId}`, { method: 'DELETE' });
	    if(res.ok) {
	        alert("Record Deleted");
	        viewAcademicRecords(studId); // Refresh the list
	    }
	}
// --- FORM FOR ADD/EDIT ---
   function academicFormUI(studId, existingData = null) {
       const isEdit = !!existingData;
       let content = `
           <div class="space-y-3">
               <input type="text" id="ac-course" placeholder="Course Name (e.g. B.Tech)" class="w-full p-3 bg-slate-100 rounded-xl" value="${isEdit ? existingData.courseName : ''}">
               <input type="text" id="ac-year" placeholder="Academic Year (e.g. 2023-24)" class="w-full p-3 bg-slate-100 rounded-xl" value="${isEdit ? existingData.academicYear : ''}">
               <input type="number" id="ac-current" placeholder="Current Year (1, 2, 3...)" class="w-full p-3 bg-slate-100 rounded-xl" value="${isEdit ? existingData.currentYear : ''}">
               <select id="ac-status" class="w-full p-3 bg-slate-100 rounded-xl font-bold">
                   <option value="Pass" ${isEdit && existingData.status === 'Pass' ? 'selected' : ''}>Pass</option>
                   <option value="Fail" ${isEdit && existingData.status === 'Fail' ? 'selected' : ''}>Fail</option>
               </select>
           </div>`;
       
       openModal(isEdit ? "Edit Record" : "Add Record", content, true, () => submitAcademic(studId, isEdit ? existingData.id : null));
   }

// --- SUBMIT (POST or PUT) ---
async function submitAcademic(studId, recordId = null) {
    // 1. Capture the form data
    const payload = {
        courseName: document.getElementById('ac-course').value,
        academicYear: document.getElementById('ac-year').value,
        currentYear: parseInt(document.getElementById('ac-current').value),
        status: document.getElementById('ac-status').value
    };

    // 2. Determine URL and Method
    const url = recordId ? `${API}/college/academic/update/${recordId}` : `${API}/college/academic/add/${studId}`;
    const method = recordId ? 'PUT' : 'POST';

    try {
        const res = await fetch(url, {
            method: method,
            // We use standard headers instead of the missing getHeaders() function
            headers: { 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert(recordId ? "Record Updated!" : "Record Added!");
            closeModal(); // Close the modal window
            viewAcademicRecords(studId); // Refresh the list automatically
        } else {
            const errorText = await res.text();
            alert("Server Error: " + errorText);
        }
    } catch (err) {
        console.error("Connection failed:", err);
        alert("Could not connect to the server.");
    }
}
async function deleteAcademic(recordId, studId) {
    if (!confirm("Are you sure you want to delete this academic record?")) return;

    try {
        const res = await fetch(`${API}/college/academic/delete/${recordId}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            alert("Record deleted successfully.");
            viewAcademicRecords(studId); // Refresh the list
        } else {
            alert("Delete failed. The record might already be gone.");
        }
    } catch (err) {
        console.error("Delete error:", err);
    }
}
    // --- MARKS ---
    async function addMarks(studId) {
        const res = await fetch(`${API}/college/marks/student/${studId}`);
        const marksList = await res.json();
        let content = `
            <div class="space-y-3">
                <button onclick="marksFormUI(${studId})" class="w-full mb-4 p-3 bg-amber-500 text-white rounded-2xl font-bold">+ Entry Marks</button>
                <div class="space-y-2">
                    ${marksList.map(m => `
                        <div class="p-4 bg-slate-50 rounded-2xl border flex justify-between items-center">
                            <div><p class="font-black text-slate-800">${m.subject}</p><p class="text-[10px] text-slate-500 font-bold uppercase">${m.testType}: ${m.obtainedMarks}/${m.outOf}</p></div>
                            <div class="flex gap-2">
                                <button onclick="marksFormUI(${studId}, ${JSON.stringify(m).replace(/"/g, '&quot;')})" class="text-blue-500"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteMark(${m.marksId}, ${studId})" class="text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`).join('')}
                </div>
            </div>`;
        openModal("Examination Center", content, false);
    }

    function marksFormUI(studId, data = null) {
        const isEdit = !!data;
        let content = `
            <div class="space-y-4">
                <input type="text" id="m-sub" class="w-full p-4 bg-slate-100 rounded-xl" placeholder="Subject" value="${isEdit ? data.subject : ''}">
                <input type="text" id="m-type" class="w-full p-4 bg-slate-100 rounded-xl" placeholder="Type" value="${isEdit ? data.testType : ''}">
                <div class="flex gap-2">
                    <input type="number" id="m-got" class="flex-1 p-4 bg-slate-100 rounded-xl" placeholder="Marks" value="${isEdit ? data.obtainedMarks : ''}">
                    <input type="number" id="m-out" class="flex-1 p-4 bg-slate-100 rounded-xl" placeholder="Total" value="${isEdit ? data.outOf : ''}">
                </div>
            </div>`;
        openModal(isEdit ? "Update Marks" : "Add Marks", content, true, () => submitMarks(studId, data?.marksId));
    }

    async function submitMarks(studId, marksId = null) {
        const payload = { subject: document.getElementById('m-sub').value, testType: document.getElementById('m-type').value, obtainedMarks: parseFloat(document.getElementById('m-got').value), outOf: parseFloat(document.getElementById('m-out').value) };
        const url = marksId ? `${API}/college/marks/${marksId}` : `${API}/college/marks/${studId}`;
        const res = await fetch(url, { method: marksId ? 'PUT' : 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        if(res.ok) addMarks(studId);
    }

    async function deleteMark(id, studId) { await fetch(`${API}/college/marks/${id}`, { method: 'DELETE' }); addMarks(studId); }

    // --- OTHER UI ACTIONS ---
 // --- 1. VIEW FEE SUMMARY & HISTORY ---
async function checkFees(studId) {
    try {
        const res = await fetch(`${API}/college/fees/student/${studId}`);
        
        if (res.status === 404) {
            // If no record exists, we offer to set up the billing (Total Fees)
            return openModal("Fee Management", `
                <div class="text-center py-10">
                    <i class="fas fa-file-invoice-dollar text-4xl text-slate-200 mb-4"></i>
                    <p class="text-slate-500 font-bold">No fee record found for this student.</p>
                    <button onclick="initFeeUI(${studId})" class="mt-4 px-6 py-2 bg-slate-900 text-white rounded-xl font-bold">Initialize Billing</button>
                </div>
            `, false);
        }

        const fee = await res.json();
        // Payment history comes from your 'paymentHistory' list in Java
        const history = fee.paymentHistory || [];

        let content = `
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-900 rounded-2xl text-white">
                        <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Total + Exam</p>
                        <p class="text-xl font-black">‚Çπ${fee.totalAmount + (fee.examFees || 0)}</p>
                    </div>
                    <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <p class="text-[10px] font-black text-emerald-500 uppercase tracking-widest">Total Paid</p>
                        <p class="text-xl font-black text-emerald-700">‚Çπ${fee.paidAmount}</p>
                    </div>
                </div>

                <div class="p-4 bg-red-50 rounded-2xl border-2 border-red-100 text-center">
                    <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest">Remaining Balance</p>
                    <p class="text-3xl font-black text-red-600">‚Çπ${fee.dueAmount}</p>
                </div>

                <div class="flex gap-2">
                    <button onclick="paymentFormUI(${studId})" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black shadow-lg">
                        + Pay Fees
                    </button>
                    <button onclick="editBillingUI(${studId}, ${JSON.stringify(fee).replace(/"/g, '&quot;')})" class="px-4 bg-slate-100 text-slate-600 rounded-2xl">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>

                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Transaction History</p>
                    <div class="max-h-52 overflow-y-auto space-y-2 pr-2">
                        ${history.map(p => `
                            <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <div>
                                    <p class="font-black text-slate-800">‚Çπ${p.amountPaid}</p>
                                    <p class="text-[10px] text-slate-400 font-bold">${new Date(p.paymentDate).toLocaleDateString()}</p>
                                </div>
                                <button onclick="deletePayment(${p.id}, ${studId})" class="w-8 h-8 text-red-300 hover:text-red-600 transition-all">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        `).join('') || '<p class="text-center py-6 text-slate-300 italic">No payments yet.</p>'}
                    </div>
                </div>
            </div>`;
        openModal("Fee Administration", content, false);
    } catch (err) {
        console.error(err);
    }
}
    
//UI to set the Initial Course Fee
function initFeeUI(studId) {
    let content = `
        <div class="space-y-4">
            <div class="p-3 bg-amber-50 border border-amber-100 rounded-xl">
                <p class="text-[10px] font-bold text-amber-600 uppercase">First Time Setup</p>
                <p class="text-xs text-amber-700">Set the base tuition and exam fees to create this account.</p>
            </div>
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Total Tuition Fee</label>
                <input type="number" id="init-total" placeholder="e.g. 50000" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold">
            </div>
            <div>
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Exam Fee</label>
                <input type="number" id="init-exam" placeholder="e.g. 2000" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold">
            </div>
        </div>`;

    openModal("Initialize Student Account", content, true, () => {
        const total = document.getElementById('init-total').value;
        const exam = document.getElementById('init-exam').value;
        submitInitFee(studId, total, exam);
    });
}

async function submitInitFee(studId, total, exam) {
    try {
        // STEP 1: Create the record in DB using your /pay endpoint (which has orElseGet logic)
        // We send a 0 amount just to trigger the creation of the Fees object
        const createRes = await fetch(`${API}/college/fees/${studId}/pay?amount=0`, { method: 'POST' });

        if (!createRes.ok) throw new Error("Database failed to create record");

        // STEP 2: Now update the billing with the actual amounts
        const payload = {
            totalAmount: parseFloat(total) || 0,
            examFees: parseFloat(exam) || 0,
            paidAmount: 0
        };

        const updateRes = await fetch(`${API}/college/fees/update-billing/${studId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (updateRes.ok) {
            alert("Billing Assigned!");
            closeModal();
            checkFees(studId); // Refresh the student view
            loadUnassignedStudents(); // Refresh the dashboard list
        }
    } catch (err) {
        alert("Error: " + err.message);
    }
}
function editBillingUI(studId, fee) {
    let content = `
        <div class="space-y-4">
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase">Total Course Fee</label>
                <input type="number" id="edit-total" class="w-full p-4 bg-slate-50 rounded-2xl font-bold" value="${fee.totalAmount}">
            </div>
            <div>
                <label class="text-[10px] font-bold text-slate-400 uppercase">Exam Fee</label>
                <input type="number" id="edit-exam" class="w-full p-4 bg-slate-50 rounded-2xl font-bold" value="${fee.examFees}">
            </div>
        </div>`;

    openModal("Edit Billing", content, true, async () => {
        const payload = {
            totalAmount: parseFloat(document.getElementById('edit-total').value),
            examFees: parseFloat(document.getElementById('edit-exam').value),
            paidAmount: fee.paidAmount // Keep existing payments
        };

        const res = await fetch(`${API}/college/fees/update-billing/${studId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            alert("Billing Updated!");
            checkFees(studId);
        }
    });
}
// --- 2. PAYMENT COLLECTION UI ---
function paymentFormUI(studId) {
    let content = `
        <div class="space-y-4">
            <div class="p-4 bg-blue-50 rounded-2xl border border-blue-100">
                <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Payment Portal</p>
                <p class="font-bold text-blue-800 italic">Processing for Student ID: #${studId}</p>
            </div>
            <div class="space-y-1">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Enter Amount to Pay</label>
                <input type="number" id="p-amount" placeholder="0.00" 
                       class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-black text-xl focus:ring-4 focus:ring-blue-100 transition-all">
            </div>
        </div>`;
    
    // We pass the submit function directly to the modal helper
    openModal("Add Payment", content, true, () => submitPayment(studId));
}
// --- 3. SUBMIT NEW PAYMENT ---
// --- 2. THE SUBMIT FUNCTION (Matches your Java @PostMapping) ---
async function submitPayment(studId) {
    // 1. Find the element first
    const amountInput = document.getElementById('p-amount');
    
    // 2. Error Check: If the input doesn't exist in the DOM
    if (!amountInput) {
        console.error("Input 'p-amount' not found in DOM");
        return;
    }

    const amount = amountInput.value;
    
    if (!amount || amount <= 0) {
        alert("Please enter a valid amount.");
        return;
    }

    // 3. Prepare URL for your @RequestParam backend
    const url = `${API}/college/fees/${studId}/pay?amount=${amount}`;

    try {
        const res = await fetch(url, { 
            method: 'POST',
            // If you use Spring Security, you might need to include credentials
            headers: { 'Accept': 'application/json' } 
        });

        if (res.status === 401) {
            alert("Session expired. Please login again.");
            return;
        }

        if (res.ok) {
            // Your backend returns the Fee object, but we need to check if it's valid JSON
            const text = await res.text();
            try {
                JSON.parse(text);
                alert("Payment Success!");
                closeModal(); // Close the modal only AFTER success
                checkFees(studId); // Refresh list
            } catch (e) {
                // If it's not JSON, it might just be a success string
                alert("Payment Recorded");
                closeModal();
                checkFees(studId);
            }
        } else {
            alert("Server error. Please try again.");
        }
    } catch (err) {
        console.error("Fetch error:", err);
    }
}
// --- 4. DELETE PAYMENT (The Admin Function) ---
async function deletePayment(paymentId, studId) {
    if (!confirm("Are you sure you want to delete this payment record? This will increase the student's balance due.")) return;

    try {
        const res = await fetch(`${API}/college/fees/payment/${paymentId}`, {
            method: 'DELETE'
        });

        if (res.ok) {
            alert("Payment deleted.");
            checkFees(studId); // Refresh the list and totals
        } else {
            alert("Could not delete record. It may have already been removed.");
        }
    } catch (err) {
        console.error("Delete Error:", err);
    }
}
    async function submitFee(studId, feeId = null) {
        const payload = {
            totalAmount: parseFloat(document.getElementById('f-total').value),
            paidAmount: parseFloat(document.getElementById('f-paid').value)
        };

        // Use your FeeController mapping (assuming POST for add and PUT/POST for update)
        const url = feeId ? `${API}/college/fees/update/${feeId}` : `${API}/college/fees/add/${studId}`;
        const method = feeId ? 'PUT' : 'POST';

        const res = await fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });

        if(res.ok) {
            alert("Fee record updated successfully!");
            checkFees(studId); // Return to the summary view
        }
    }
    
    

   
    async function deleteFeeRecord(feeId, studId) {
        if(!confirm("Are you sure? This will wipe the student's financial history.")) return;
        const res = await fetch(`${API}/college/fees/delete/${feeId}`, { method: 'DELETE' });
        if(res.ok) {
            alert("Fee Record Removed");
            checkFees(studId);
        }
    }
    function feeFormUI(studId, data = null) {
        const isEdit = !!data;
        let content = `
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Total Course Fee</label>
                    <input type="number" id="f-total" class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none mt-1" value="${isEdit ? data.totalAmount : 0}">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase ml-2">Amount Paid to Date</label>
                    <input type="number" id="f-paid" class="w-full p-4 bg-slate-100 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none mt-1" value="${isEdit ? data.paidAmount : 0}">
                </div>
            </div>
        `;
        openModal(isEdit ? "Update Fee Record" : "New Fee Record", content, true, () => submitFee(studId, data?.feeId));
    }
    async function viewParents(studId) {
        const res = await fetch(`${API}/college/parents/student/${studId}`);
        const parents = await res.json();
        let content = `<div class="space-y-4">${parents.map(p => `
            <div class="p-4 bg-purple-50 rounded-2xl border border-purple-100 flex items-center gap-4">
                <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center text-white"><i class="fas fa-phone"></i></div>
                <div><p class="font-bold text-purple-900">${p.parentName}</p><p class="text-xs font-bold text-purple-400 uppercase">${p.phone}</p></div>
            </div>`).join('') || 'None'}</div>`;
        openModal("Guardian Info", content, false);
    }

    async function studentDetails(studId) {
        const res = await fetch(`${API}/college/students/${studId}`);
        const s = await res.json();
        let content = `
            <div class="space-y-4 font-medium text-slate-600">
                <div class="flex justify-between border-b pb-2"><span>Full Name:</span><span class="font-bold text-slate-800">${s.fullName}</span></div>
                <div class="flex justify-between border-b pb-2"><span>Email:</span><span class="font-bold text-slate-800">${s.email}</span></div>
                <div class="flex justify-between border-b pb-2"><span>Phone:</span><span class="font-bold text-slate-800">${s.phone}</span></div>
                <div class="flex justify-between border-b pb-2"><span>Address:</span><span class="font-bold text-slate-800 text-right text-xs">${s.address}</span></div>
            </div>`;
        openModal("Full Student Profile", content, false);
    }

    async function loadUnassigned() {
        const res = await fetch(`${API}/college/students/all`);
        const all = await res.json();
        const filtered = all.filter(s => !s.faculty);
        document.getElementById('unassignedList').innerHTML = filtered.map(s => `
            <tr>
                <td class="px-8 py-5"><input type="checkbox" class="stu-check w-6 h-6 rounded-lg text-blue-600" value="${s.studId}"></td>
                <td class="px-8 py-5 font-bold text-slate-800">${s.fullName}</td>
                <td class="px-8 py-5 uppercase text-xs tracking-widest font-bold text-slate-400">${s.course}</td>
            </tr>`).join('');
    }

    async function processAssignment() {
        const ids = Array.from(document.querySelectorAll('.stu-check:checked')).map(c => parseInt(c.value));
        if(ids.length === 0) return alert("Select students first.");
        const res = await fetch(`${API}/api/faculty/${faculty.id}/assign-students`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(ids) });
        if(res.ok) showTab('students', document.querySelector('.nav-item'));
    }

    function populateProfile() {
        document.getElementById('profName').value = faculty.name;
        document.getElementById('profId').value = faculty.facultyId;
        document.getElementById('profSub').value = faculty.subject;
        document.getElementById('profSal').value = faculty.salary || 0;
    }

    async function updateProfile() {
        const payload = {
            name: document.getElementById('profName').value,
            subject: document.getElementById('profSub').value,
            salary: parseFloat(document.getElementById('profSal').value),
            facultyId: document.getElementById('profId').value,
            password: document.getElementById('profPass').value
        };
        const res = await fetch(`${API}/api/faculty/${faculty.id}/update-profile`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
        });
        if (res.ok) {
            faculty = await res.json();
            localStorage.setItem('facultySession', JSON.stringify(faculty));
            refreshHeader(); alert("Profile Updated!");
        }
    }

    async function viewTodayAbsentees() {
        const today = new Date().toISOString().split('T')[0];
        const res = await fetch(`${API}/college/attendance/all?date=${today}`);
        const records = await res.json();
        const facultyStudentIds = allAssignedStudents.map(s => s.studId);
        const absentees = records.filter(r => r.status === 'ABSENT' && facultyStudentIds.includes(r.student.studId));
        
        let content = `<div class="space-y-2">${absentees.map(a => `
            <div class="flex justify-between items-center p-4 bg-red-50 rounded-2xl border border-red-100">
                <span class="font-bold text-red-800">${a.student.fullName}</span>
                <button onclick="updateAttendanceStatus(${a.attendId}, 'PRESENT', ${a.student.studId})" class="text-[10px] font-black uppercase bg-white px-3 py-1 rounded-lg border border-red-200">Revert</button>
            </div>`).join('') || '<p class="text-center py-6 text-slate-400 font-bold">No absentees yet.</p>'}</div>`;
        openModal("System Absentee List", content, false);
    }
    
 // --- THE MAIN ENGINE ---
    function downloadExcel(data, fileName) {
        if (!data || data.length === 0) {
            alert("No data available to download");
            return;
        }
        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data_Export");
        XLSX.writeFile(workbook, `${fileName}.xlsx`);
    }

    // --- EXAMINATION CENTER EXPORT ---
    async function exportExamResults() {
        try {
            const res = await fetch(`${API}/college/academic/all`); // Or your specific exam endpoint
            const records = await res.json();
            
            const exportData = records.map(r => ({
                "Student ID": r.student?.studId,
                "Student Name": r.student?.name,
                "Course": r.courseName,
                "Year": r.currentYear,
                "Result": r.status
            }));

            downloadExcel(exportData, "Examination_Report_" + new Date().toLocaleDateString());
        } catch (err) {
            alert("Exam Export Failed: Check if 'All Academic' endpoint is active.");
        }
    }
    function feeAdminUI() {
        let content = `
            <div class="flex justify-between items-center bg-emerald-50 p-4 rounded-2xl mb-4">
                <div>
                    <h3 class="font-black text-emerald-800">Financial Records</h3>
                    <p class="text-[10px] text-emerald-600 uppercase font-bold">Export master ledger</p>
                </div>
                <button onclick="exportFees()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold text-xs flex items-center gap-2 shadow-lg shadow-emerald-100">
                    <i class="fas fa-file-excel"></i> DOWNLOAD EXCEL
                </button>
            </div>
            `;
        openModal("Fee Administration", content, false);
    }
    
 // Ensure this is outside any other curly braces { }
  async function downloadMasterReport() {
    try {
        // Use individual fetches to ensure one failure doesn't kill the whole process
        const [sRes, fRes, aRes] = await Promise.all([
            fetch(`${API}/college/students/all`),
            fetch(`${API}/college/fees/all`),
            fetch(`${API}/college/academic/all`)
        ]);

        const students = sRes.ok ? await sRes.json() : [];
        const fees = fRes.ok ? await fRes.json() : [];
        const academics = aRes.ok ? await aRes.json() : [];

        const wb = XLSX.utils.book_new();

        // 1. STUDENTS SHEET (Basic mapping)
        const wsStud = XLSX.utils.json_to_sheet(students.map(s => ({
            "Student ID": s.studId,
            "Full Name": s.name,
            "Department": s.department,
            "Email": s.email
        })));
        XLSX.utils.book_append_sheet(wb, wsStud, "Students");

        // 2. FEES SHEET (Crucial: Mapping nested student data)
        const wsFees = XLSX.utils.json_to_sheet(fees.map(f => ({
            "Student ID": f.student ? f.student.studId : "N/A",
            "Student Name": f.student ? f.student.name : "Unknown",
            "Course Fee": f.totalAmount,
            "Exam Fee": f.examFees,
            "Total Paid": f.paidAmount,
            "Balance Due": f.dueAmount
        })));
        XLSX.utils.book_append_sheet(wb, wsFees, "Finance");

        // 3. ACADEMIC SHEET (Mapping nested data)
        const wsAcad = XLSX.utils.json_to_sheet(academics.map(a => ({
            "Student ID": a.student ? a.student.studId : "N/A",
            "Student Name": a.student ? a.student.name : "Unknown",
            "Course": a.courseName,
            "Year": a.currentYear,
            "Academic Session": a.academicYear,
            "Result": a.status
        })));
        XLSX.utils.book_append_sheet(wb, wsAcad, "Academics");

        // Generate and Save
        XLSX.writeFile(wb, "College_Full_Database_Export.xlsx");

    } catch (err) {
        console.error("Export Logic Error:", err);
        alert("Some data could not be retrieved. Check console for details.");
    }
}
    function handleLogout() { localStorage.clear(); window.location.href = "faculty-auth.html"; }
    </script>
</body>
</html>